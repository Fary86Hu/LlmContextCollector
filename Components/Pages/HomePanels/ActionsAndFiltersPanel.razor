@inject AppState AppState
@implements IDisposable
@using System.ComponentModel

<div class="panel panel-middle">
    <div class="middle-buttons">
        <button @onclick="OnAddSelectedToContext">&gt;&gt; Hozzáadás</button>
        <button @onclick="OnExcludeSelected">Kizárás</button>
        <button @onclick="OnRemoveSelectedFromContext">&lt;&lt; Eltávolítás</button>
        <div class="ref-finder">
            <label for="ref-depth">Ref. mélység:</label>
            <input type="number" id="ref-depth" min="0" max="5" @bind="AppState.ReferenceSearchDepth" />
            
            <div class="checkbox-wrapper" style="margin-left: 10px; display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" id="ref-include-referencing" @bind="AppState.IncludeReferencingFiles" />
                <label for="ref-include-referencing" title="Keressen olyan fájlokat is, amelyek hivatkoznak a hozzáadott fájlokra (pl. Program.cs a Service-ek esetén)">Hivatkozók</label>
            </div>
        </div>
    </div>

    <div class="filters-box">
        <h4>Szűrők</h4>

        <div class="filter-section">
            <strong>Aktív fájltípusok:</strong>
            <div class="extensions-list">
                @foreach (var extKvp in AppState.ExtensionCounts.OrderByDescending(x => x.Value))
                {
                    var currentExt = extKvp.Key;
                    var count = extKvp.Value;
                    if (AppState.ExtensionFilters.ContainsKey(currentExt))
                    {
                        <div>
                            <input type="checkbox" id="@($"ext-{currentExt}")" @bind="AppState.ExtensionFilters[currentExt]" />
                            <label for="@($"ext-{currentExt}")">@currentExt (@count)</label>
                        </div>
                    }
                }
            </div>
        </div>


        <div class="filter-section">
            <strong>Kizárások:</strong>
            <textarea class="ignore-patterns" @bind="AppState.IgnorePatternsRaw" @bind:event="oninput"></textarea>
        </div>

        <button class="apply-filters-btn" @onclick="OnApplyFilters">Alkalmaz és Újratölt</button>
    </div>
</div>

@code {
    [Parameter]
    public EventCallback OnAddSelectedToContext { get; set; }

    [Parameter]
    public EventCallback OnExcludeSelected { get; set; }

    [Parameter]
    public EventCallback OnRemoveSelectedFromContext { get; set; }

    [Parameter]
    public EventCallback OnApplyFilters { get; set; }


    protected override void OnInitialized()
    {
        AppState.PropertyChanged += OnAppStateChanged;
    }

    private async void OnAppStateChanged(object? sender, PropertyChangedEventArgs e)
    {
        if (e.PropertyName == nameof(AppState.IgnorePatternsRaw) ||
            e.PropertyName == nameof(AppState.ExtensionFilters) ||
            e.PropertyName == nameof(AppState.ExtensionCounts) ||
            e.PropertyName == nameof(AppState.ReferenceSearchDepth) ||
            e.PropertyName == nameof(AppState.IncludeReferencingFiles))
        {
            await InvokeAsync(StateHasChanged);
        }
    }


    public void Dispose()
    {
        AppState.PropertyChanged -= OnAppStateChanged;
    }
}