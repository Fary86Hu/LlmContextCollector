<div class="panel panel-right" style="--right-top-flex:@(AppState.RightTopPanelFlex); --right-middle-flex:@(AppState.RightMiddlePanelFlex); --right-bottom-flex:@(AppState.RightBottomPanelFlex);">
    
    @if (!_isBrowserMode)
    {
        <div class="right-top-section">
            <div class="toolbar" style="align-items: center;">
                <label for="prompt-template" style="margin-right: 5px;">Prompt Sablon:</label>
                <select id="prompt-template" style="flex-grow: 1;" @bind="AppState.SelectedPromptTemplateId">
                    <option value="@Guid.Empty">(Nincs)</option>
                    @foreach (var prompt in AppState.PromptTemplates)
                    {
                        <option value="@prompt.Id">@prompt.Title</option>
                    }
                </select>
                <button @onclick="OnShowPromptManager">Szerkeszt√©s...</button>
                <button @onclick="OnShowSettingsDialog" title="Be√°ll√≠t√°sok" style="margin: 0 5px;">‚öôÔ∏è</button>
            </div>
            <div class="prompt-container">
                <textarea class="prompt-editor" placeholder="√çrja ide a promptot..." @bind="AppState.PromptText" @bind:event="oninput"></textarea>
                @if (!string.IsNullOrWhiteSpace(AppState.PromptText))
                {
                    <div class="prompt-editor-button-group">
                        <button class="prompt-editor-btn" @onclick="ClearPrompt" title="Prompt t√∂rl√©se">&times;</button>
                    </div>
                }
            </div>
        </div>

        <div class="horizontal-splitter" @onmousedown='e => OnSplitterMouseDown.InvokeAsync((e, "RightTop"))'></div>

        <div class="right-middle-section">
            <div class="context-list-header">
                <h4>Kiv√°lasztott F√°jlok (Kontextushoz)</h4>
            </div>
            <div class="context-table-container" @onkeydown="HandleListKeyDown" tabindex="0">
                <table class="context-table">
                    <thead>
                        <tr>
                            <th class="sortable @GetSortClass("path")" @onclick='() => SortBy("path")'>El√©r√©si √∫t</th>
                            <th class="sortable @GetSortClass("name")" @onclick='() => SortBy("name")'>F√°jln√©v</th>
                            <th class="sortable @GetSortClass("semantic")" @onclick='() => SortBy("semantic")'>Egyez√©s</th>
                            <th class="sortable @GetSortClass("size")" @onclick='() => SortBy("size")'>M√©ret</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var fileInfo in _sortedFiles)
                        {
                            <tr @key="fileInfo.RelativePath"
                                class="@(SelectedItems.Contains(fileInfo.RelativePath) ? "selected" : "")"
                                @onclick="(e) => OnFileRowClick(e, fileInfo.RelativePath)"
                                @oncontextmenu="(e) => ShowContextMenuForRow(e, fileInfo.RelativePath)" @oncontextmenu:preventDefault>
                                <td>@fileInfo.DisplayPath</td>
                                <td>@fileInfo.FileName</td>
                                <td style="text-align: right;">@(fileInfo.SemanticScore >= 0 ? fileInfo.SemanticScore.ToString("F2") : "-")</td>
                                <td style="text-align: right;">@fileInfo.Size.ToString("N0")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="toolbar">
                <button title="Visszavon√°s" @onclick="AppState.UndoContextListChange" disabled="@(!AppState.CanUndo)">‚Æå</button>
                <button title="√öjra" @onclick="AppState.RedoContextListChange" disabled="@(!AppState.CanRedo)">‚Æç</button>
            
                <button style="margin: 0 5px;" @onclick="OnShowDocumentSearchDialog" disabled="@(AppState.IsSemanticIndexBuilding || !IsIndexReady)">Keres√©s</button>
            
                <span style="margin-left:auto;"></span>
                <span class="char-counter">@_charCount.ToString("N0") kar.</span>
                <span class="char-counter">~@_tokenCount.ToString("N0") tok.</span>
                <button @onclick="ClearSelectionList">Lista √ºr√≠t√©se</button>
            </div>
        </div>

        <div class="horizontal-splitter" @onmousedown='e => OnSplitterMouseDown.InvokeAsync((e, "RightMiddle"))'></div>

        <div class="right-bottom-section">
            <div class="preview-header">
                <h4>F√°jl El≈ën√©zet</h4>
                <div class="preview-search-controls">
                    <input type="text" 
                           placeholder="Keres√©s..." 
                           @bind="_previewSearchTerm" 
                           @bind:event="oninput" 
                           @onkeyup="HandlePreviewSearchKeyup" />
                    @if (_totalPreviewMatches > 0)
                    {
                        <span class="preview-match-counter">@_currentPreviewMatchIndex/@_totalPreviewMatches</span>
                    }
                    <button @onclick="FindPreviousInPreview" disabled="@(_totalPreviewMatches == 0)" title="El≈ëz≈ë">‚ñ≤</button>
                    <button @onclick="FindNextInPreview" disabled="@(_totalPreviewMatches == 0)" title="K√∂vetkez≈ë">‚ñº</button>
                    <button @onclick="ClearPreviewSearch" disabled="@(string.IsNullOrEmpty(_previewSearchTerm))" class="clear-btn">&times;</button>
                </div>
            </div>
            <div id="preview-box" class="preview-box">
                <pre>@_previewContentMarkup</pre>
            </div>
        </div>
    }
    else
    {
        <div class="browser-placeholder-mode">
            <div class="browser-placeholder-info">
                <h3>B√∂ng√©sz≈ë Akt√≠v</h3>
                <p>A b√∂ng√©sz≈ë egy k√ºl√∂n r√©tegen ny√≠lt meg.</p>
                <p>
                    1. Illeszd be a v√°g√≥lap tartalm√°t a b√∂ng√©sz≈ëben l√©v≈ë AI Studi√≥ba.<br/>
                    2. V√°rd meg a v√°laszt.<br/>
                    3. Kattints a b√∂ng√©sz≈ë alj√°n l√©v≈ë <strong>"V√°lasz Feldolgoz√°sa"</strong> gombra.
                </p>
                <button @onclick="CloseBrowserMode">B√∂ng√©sz≈ë elrejt√©se / Bez√°r√°sa</button>
            </div>
        </div>
    }

    <div class="bottom-actions">
        <div class="copy-options">
            <label title="Felhaszn√°l√≥i prompt hozz√°ad√°sa"><input type="checkbox" @bind="_includePromptInCopy" />Prompt</label>
            <label title="Rendszer utas√≠t√°sok hozz√°ad√°sa"><input type="checkbox" @bind="_includeSystemPrompt" />System</label>
        </div>
        <div class="main-actions">
            <button class="copy-button" @onclick="CopyToClipboard" title="V√°g√≥lapra m√°sol√°s (a pip√°knak megfelel≈ëen)">M√°sol√°s</button>
            
            @if (!_isBrowserMode)
            {
                <button class="copy-button" @onclick="OpenAiStudioBrowser" title="AI Studio megnyit√°sa bels≈ë b√∂ng√©sz≈ëben">üåê AI Studio</button>
            }

            <button @onclick="ProcessGitDiffAsync" disabled="@(!AppState.IsGitRepository)">Git K√ºl√∂nbs√©gek</button>
            <button class="copy-button" @onclick="ProcessChangesFromClipboardAsync" title="V√°g√≥lap feldolgoz√°sa (K√©rd√©s vagy Implement√°ci√≥)">Feldolgoz</button>
        </div>
    </div>
</div>

<ClarificationDialog IsVisible="_isClarificationDialogVisible" 
                     ClipboardText="@_clarificationDialogText" 
                     OnClose="OnClarificationDialogClose" 
                     OnGenerateRefinedPrompt="HandleGenerateRefinedPrompt" />