<div class="panel panel-right" style="--right-top-flex:@(AppState.RightTopPanelFlex); --right-middle-flex:@(AppState.RightMiddlePanelFlex); --right-bottom-flex:@(AppState.RightBottomPanelFlex);">
    
    <div class="right-top-section">
        <div class="toolbar" style="align-items: center;">
            <label for="prompt-template" style="margin-right: 5px;">Glob√°lis Prompt:</label>
            <select id="prompt-template" style="flex-grow: 1;" @bind="AppState.ActiveGlobalPromptId">
                @foreach (var prompt in AppState.PromptTemplates)
                {
                    <option value="@prompt.Id">@prompt.Title</option>
                }
            </select>
            <button @onclick="OnShowPromptManager">Szerkeszt√©s...</button>
            <button @onclick="OnShowSettingsDialog" title="Be√°ll√≠t√°sok" style="margin: 0 5px;">‚öôÔ∏è</button>
        </div>
        <div class="prompt-container">
            <textarea class="prompt-editor" placeholder="√çrja ide a promptot..." @bind="AppState.PromptText" @bind:event="oninput"></textarea>
            @if (!string.IsNullOrWhiteSpace(AppState.PromptText))
            {
                <div class="prompt-editor-button-group">
                    <button class="prompt-editor-btn" @onclick="ClearPrompt" title="Prompt t√∂rl√©se">&times;</button>
                </div>
            }
        </div>
    </div>

    <div class="horizontal-splitter" @onmousedown='e => OnSplitterMouseDown.InvokeAsync((e, "RightTop"))'></div>

    <div class="right-middle-section">
        <div class="context-list-header">
            <h4>Kiv√°lasztott F√°jlok (Kontextushoz)</h4>
        </div>
        <div class="context-table-container" @onkeydown="HandleListKeyDown" tabindex="0">
            <table class="context-table">
                <thead>
                    <tr>
                        <th class="sortable @GetSortClass("path")" @onclick='() => SortBy("path")'>El√©r√©si √∫t</th>
                        <th class="sortable @GetSortClass("name")" @onclick='() => SortBy("name")'>F√°jln√©v</th>
                        <th class="sortable @GetSortClass("size")" @onclick='() => SortBy("size")'>M√©ret</th>
                        <th>M≈±veletek</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var fileInfo in _sortedFiles)
                    {
                        <tr @key="fileInfo.RelativePath"
                            class="@(SelectedItems.Contains(fileInfo.RelativePath) ? "selected" : "")"
                            @onclick="(e) => OnFileRowClick(e, fileInfo.RelativePath)"
                            @oncontextmenu="(e) => ShowContextMenuForRow(e, fileInfo.RelativePath)" @oncontextmenu:preventDefault>
                            <td>@fileInfo.DisplayPath</td>
                            <td>@fileInfo.FileName</td>
                            <td style="text-align: right;">@fileInfo.Size.ToString("N0")</td>
                            <td class="actions-cell" @onclick:stopPropagation>
                                <button class="icon-btn-small" title="Referenci√°k hozz√°ad√°sa (1 m√©lys√©g)" @onclick="() => OnAddReferencesClick(fileInfo.RelativePath)">üîó</button>
                                <button class="icon-btn-small" title="Hivatkoz√≥ f√°jlok hozz√°ad√°sa" @onclick="() => OnAddReferencingClick(fileInfo.RelativePath)">üëà</button>
                                <button class="icon-btn-small delete-btn" title="T√∂rl√©s a list√°b√≥l" @onclick="() => OnRemoveItemClick(fileInfo.RelativePath)">üóëÔ∏è</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="toolbar">
            <button title="Visszavon√°s" @onclick="AppState.UndoContextListChange" disabled="@(!AppState.CanUndo)">‚Æå</button>
            <button title="√öjra" @onclick="AppState.RedoContextListChange" disabled="@(!AppState.CanRedo)">‚Æç</button>
        
            <button style="margin: 0 5px;" @onclick="OnShowDocumentSearchDialog" disabled="@(AppState.IsSemanticIndexBuilding || !IsIndexReady)">Keres√©s</button>
        
            <span style="margin-left:auto;"></span>
            <span class="char-counter">@_charCount.ToString("N0") kar.</span>
            <span class="char-counter">~@_tokenCount.ToString("N0") tok.</span>
            <button @onclick="ClearSelectionList">Lista √ºr√≠t√©se</button>
        </div>
    </div>

    <div class="horizontal-splitter" @onmousedown='e => OnSplitterMouseDown.InvokeAsync((e, "RightMiddle"))'></div>

    <div class="right-bottom-section">
        <div class="preview-header">
            <h4>F√°jl El≈ën√©zet</h4>
            <div class="preview-search-controls">
                <div class="ref-toggle" title="Referenci√°k megjelen√≠t√©se/elrejt√©se. Z√∂ld: Kontextusban, K√©k: Nincs kontextusban.">
                    <input type="checkbox" id="chk-refs" checked="@_showReferences" @onchange="ToggleReferences" />
                    <label for="chk-refs">Ref.</label>
                </div>
                
                <input type="text" 
                       placeholder="Keres√©s..." 
                       @bind="_previewSearchTerm" 
                       @bind:event="oninput" 
                       @onkeyup="HandlePreviewSearchKeyup" 
                       disabled="@_showReferences" />
                @if (_totalPreviewMatches > 0)
                {
                    <span class="preview-match-counter">@_currentPreviewMatchIndex/@_totalPreviewMatches</span>
                }
                <button @onclick="FindPreviousInPreview" disabled="@(_totalPreviewMatches == 0 || _showReferences)" title="El≈ëz≈ë">‚ñ≤</button>
                <button @onclick="FindNextInPreview" disabled="@(_totalPreviewMatches == 0 || _showReferences)" title="K√∂vetkez≈ë">‚ñº</button>
                <button @onclick="ClearPreviewSearch" disabled="@(string.IsNullOrEmpty(_previewSearchTerm))" class="clear-btn">&times;</button>
            </div>
        </div>
        <div id="preview-box" class="preview-box">
            <pre>@_previewContentMarkup</pre>
        </div>
    </div>
    
    <script>
        window.initializePreviewInteractions = (dotNetObj) => {
            const box = document.getElementById('preview-box');
            if(box) {
                box.addEventListener('click', (e) => {
                    const target = e.target.closest('.ref-badge');
                    if (target && target.dataset.typeName) {
                        e.preventDefault();
                        e.stopPropagation();
                        dotNetObj.invokeMethodAsync('OnReferenceClicked', target.dataset.typeName);
                    }
                });
            }
        };
    </script>

    <div class="bottom-actions">
        <div class="main-actions">
            <div class="copy-group">
                <div class="copy-options-inline">
                    <label title="Felhaszn√°l√≥i prompt hozz√°ad√°sa"><input type="checkbox" @bind="_includePromptInCopy" />Prompt</label>
                    <label title="Rendszer utas√≠t√°sok hozz√°ad√°sa"><input type="checkbox" @bind="_includeSystemPrompt" />System</label>
                    <label title="Kiv√°lasztott f√°jlok tartalm√°nak hozz√°ad√°sa"><input type="checkbox" @bind="_includeFiles" />F√°jlok</label>
                </div>
                <button class="copy-button primary" @onclick="CopyToClipboard" title="V√°g√≥lapra m√°sol√°s (a pip√°knak megfelel≈ëen)">M√°sol√°s</button>
            </div>
            
            <div class="other-actions">
                <button class="copy-button" @onclick="OpenAiStudioBrowser" title="AI Studio megnyit√°sa bels≈ë b√∂ng√©sz≈ëben">üåê AI Studio</button>
                <button class="copy-button" @onclick="ProcessWithLocalAiAsync" title="Lok√°lis Ollama (Qwen3) h√≠v√°sa">üè† Lok√°lis AI</button>
                <button @onclick="ProcessGitDiffAsync" disabled="@(!AppState.IsGitRepository)">Git Diff</button>
                <button class="copy-button" @onclick="ProcessChangesFromClipboardAsync" title="V√°g√≥lap feldolgoz√°sa (K√©rd√©s vagy Implement√°ci√≥)">Feldolgoz</button>
            </div>
        </div>
    </div>
</div>

<ClarificationDialog IsVisible="_isClarificationDialogVisible" 
                     ClipboardText="@_clarificationDialogText" 
                     OnClose="OnClarificationDialogClose" 
                     OnGenerateRefinedPrompt="HandleGenerateRefinedPrompt" />