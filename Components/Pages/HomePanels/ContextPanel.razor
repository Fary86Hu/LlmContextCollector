@inject AppState AppState
@inject PromptService PromptService
@inject RelevanceFinderService RelevanceFinder
@inject IClipboard Clipboard
@inject IJSRuntime JSRuntime

<!-- JOBB OLDALI PANEL: KONTEXTUS √âS EL≈êN√âZET -->
<div class="panel panel-right" style="--right-top-flex:@(AppState.RightTopPanelFlex); --right-middle-flex:@(AppState.RightMiddlePanelFlex); --right-bottom-flex:@(AppState.RightBottomPanelFlex);">
    <div class="right-top-section">
        <div class="toolbar" style="align-items: center;">
            <label for="prompt-template" style="margin-right: 5px;">Prompt Sablon:</label>
            <select id="prompt-template" style="flex-grow: 1;" @bind="AppState.SelectedPromptTemplateId">
                <option value="@Guid.Empty">(Nincs)</option>
                @foreach (var prompt in AppState.PromptTemplates)
                {
                    <option value="@prompt.Id">@prompt.Title</option>
                }
            </select>
            <button @onclick="CopyPromptOnly" title="Csak a prompt m√°sol√°sa" style="margin: 0 5px;">üìã</button>
            <button @onclick="OnShowPromptManager">Szerkeszt√©s...</button>
            <button @onclick="OnShowSettingsDialog" title="Be√°ll√≠t√°sok" style="margin: 0 5px;">‚öôÔ∏è</button>
        </div>
        <textarea class="prompt-editor" placeholder="√çrja ide a promptot..." @bind="AppState.PromptText" @bind:event="oninput"></textarea>
    </div>

    <div class="horizontal-splitter" @onmousedown='e => OnSplitterMouseDown.InvokeAsync((e, "RightTop"))'></div>

    <div class="right-middle-section">
        <div class="context-list-header">
            <h4>Kiv√°lasztott F√°jlok (Kontextushoz)</h4>
        </div>
        <div class="context-table-container" @onkeydown="HandleListKeyDown" tabindex="0">
            <table class="context-table">
                <thead>
                    <tr>
                        <th class="sortable @GetSortClass("path")" @onclick='() => SortBy("path")'>El√©r√©si √∫t</th>
                        <th class="sortable @GetSortClass("name")" @onclick='() => SortBy("name")'>F√°jln√©v</th>
                        <th class="sortable @GetSortClass("size")" @onclick='() => SortBy("size")'>M√©ret</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var fileInfo in _sortedFiles)
                    {
                        <tr @key="fileInfo.RelativePath"
                            class="@(SelectedItems.Contains(fileInfo.RelativePath) ? "selected" : "")"
                            @onclick="(e) => OnFileRowClick(e, fileInfo.RelativePath)"
                            @oncontextmenu="(e) => ShowContextMenuForRow(e, fileInfo.RelativePath)" @oncontextmenu:preventDefault>
                            <td>@fileInfo.DisplayPath</td>
                            <td>@fileInfo.FileName</td>
                            <td style="text-align: right;">@fileInfo.Size.ToString("N0")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="toolbar">
            <button title="Visszavon√°s" @onclick="AppState.UndoContextListChange" disabled="@(!AppState.CanUndo)">‚Æå</button>
            <button title="√öjra" @onclick="AppState.RedoContextListChange" disabled="@(!AppState.CanRedo)">‚Æç</button>
            
            <button @onclick="OnAzureDevOpsAttach" title="Azure DevOps Work Item-ek let√∂lt√©se" style="margin-left: 10px;">ADO Let√∂lt√©s</button>

            @if (AppState.IsSemanticIndexBuilding)
            {
                <button style="margin: 0 5px;" disabled>Indexel√©s folyamatban...</button>
            }
            else
            {
                <button @onclick="StartManualIndexing" style="margin: 0 2px;">Index (K√≥d)</button>
                @if (AppState.AdoDocsExist)
                {
                     <button @onclick="StartIndexingAdo" style="margin: 0 2px;">Index (ADO)</button>
                }
            }
            @if (IsIndexReady)
            {
                <button style="margin: 0 5px;" @onclick="FindRelevantFiles" disabled="@AppState.IsSemanticIndexBuilding">Relev√°ns keres√©s</button>
            }
            
            <span style="margin-left:auto;"></span>
            <span class="char-counter">@_charCount.ToString("N0") kar.</span>
            <span class="char-counter">~@_tokenCount.ToString("N0") tok.</span>
            <button @onclick="ClearSelectionList">Lista √ºr√≠t√©se</button>
        </div>
    </div>

    <div class="horizontal-splitter" @onmousedown='e => OnSplitterMouseDown.InvokeAsync((e, "RightMiddle"))'></div>

    <div class="right-bottom-section">
        <h4>F√°jl El≈ën√©zet</h4>
        <textarea readonly class="preview-box">@_previewContent</textarea>
    </div>

    <div class="bottom-actions">
        <button @onclick="ProcessGitDiffAsync" disabled="@(!AppState.IsGitRepository)">Git K√ºl√∂nbs√©gek</button>
        <button @onclick="ProcessChangesFromClipboardAsync">V√°ltoz√°sok V√°g√≥lapr√≥l</button>
        <div>
            <label><input type="checkbox" @bind="_includePromptInCopy" />Prompt</label>
            <label><input type="checkbox" @bind="_includeGlobalPrefixInCopy" />Glob√°lis</label>
            <button class="copy-button" @onclick="CopyToClipboard">M√°sol√°s v√°g√≥lapra</button>
        </div>
    </div>
</div>