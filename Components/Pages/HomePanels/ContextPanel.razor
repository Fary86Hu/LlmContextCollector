<!-- JOBB OLDALI PANEL: KONTEXTUS √âS EL≈êN√âZET -->
<div class="panel panel-right" style="--right-top-flex:@(AppState.RightTopPanelFlex); --right-middle-flex:@(AppState.RightMiddlePanelFlex); --right-bottom-flex:@(AppState.RightBottomPanelFlex);">
    <div class="right-top-section">
        <div class="toolbar" style="align-items: center;">
            <label for="prompt-template" style="margin-right: 5px;">Prompt Sablon:</label>
            <select id="prompt-template" style="flex-grow: 1;" @bind="AppState.SelectedPromptTemplateId">
                <option value="@Guid.Empty">(Nincs)</option>
                @foreach (var prompt in AppState.PromptTemplates)
                {
                    <option value="@prompt.Id">@prompt.Title</option>
                }
            </select>
            <button @onclick="CopyPromptOnly" title="Csak a prompt m√°sol√°sa" style="margin: 0 5px;">üìã</button>
            <button @onclick="OnShowPromptManager">Szerkeszt√©s...</button>
            <button @onclick="OnShowSettingsDialog" title="Be√°ll√≠t√°sok" style="margin: 0 5px;">‚öôÔ∏è</button>
        </div>
        <div class="prompt-container">
            <textarea class="prompt-editor" placeholder="√çrja ide a promptot..." @bind="AppState.PromptText" @bind:event="oninput"></textarea>
            @if (!string.IsNullOrWhiteSpace(AppState.PromptText))
            {
                <div class="prompt-editor-button-group">
                    <button class="prompt-editor-btn" @onclick="CopyToClipboardForAnalysis" title="M√°sol√°s elemz√©shez">üîç</button>
                    <button class="prompt-editor-btn" @onclick="ClearPrompt" title="Prompt t√∂rl√©se">&times;</button>
                </div>
            }
        </div>
    </div>

    <div class="horizontal-splitter" @onmousedown='e => OnSplitterMouseDown.InvokeAsync((e, "RightTop"))'></div>

    <div class="right-middle-section">
        <div class="context-list-header">
            <h4>Kiv√°lasztott F√°jlok (Kontextushoz)</h4>
        </div>
        <div class="context-table-container" @onkeydown="HandleListKeyDown" tabindex="0">
            <table class="context-table">
                <thead>
                    <tr>
                        <th class="sortable @GetSortClass("path")" @onclick='() => SortBy("path")'>El√©r√©si √∫t</th>
                        <th class="sortable @GetSortClass("name")" @onclick='() => SortBy("name")'>F√°jln√©v</th>
                        <th class="sortable @GetSortClass("semantic")" @onclick='() => SortBy("semantic")'>Egyez√©s</th>
                        <th class="sortable @GetSortClass("size")" @onclick='() => SortBy("size")'>M√©ret</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var fileInfo in _sortedFiles)
                    {
                        <tr @key="fileInfo.RelativePath"
                            class="@(SelectedItems.Contains(fileInfo.RelativePath) ? "selected" : "")"
                            @onclick="(e) => OnFileRowClick(e, fileInfo.RelativePath)"
                            @oncontextmenu="(e) => ShowContextMenuForRow(e, fileInfo.RelativePath)" @oncontextmenu:preventDefault>
                            <td>@fileInfo.DisplayPath</td>
                            <td>@fileInfo.FileName</td>
                            <td style="text-align: right;">@(fileInfo.SemanticScore >= 0 ? fileInfo.SemanticScore.ToString("F2") : "-")</td>
                            <td style="text-align: right;">@fileInfo.Size.ToString("N0")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="toolbar">
            <button title="Visszavon√°s" @onclick="AppState.UndoContextListChange" disabled="@(!AppState.CanUndo)">‚Æå</button>
            <button title="√öjra" @onclick="AppState.RedoContextListChange" disabled="@(!AppState.CanRedo)">‚Æç</button>
            
            <button style="margin: 0 5px;" @onclick="OnShowDocumentSearchDialog" disabled="@(AppState.IsSemanticIndexBuilding || !IsIndexReady)">Keres√©s</button>
            
            <span style="margin-left:auto;"></span>
            <span class="char-counter">@_charCount.ToString("N0") kar.</span>
            <span class="char-counter">~@_tokenCount.ToString("N0") tok.</span>
            <button @onclick="ClearSelectionList">Lista √ºr√≠t√©se</button>
        </div>
    </div>

    <div class="horizontal-splitter" @onmousedown='e => OnSplitterMouseDown.InvokeAsync((e, "RightMiddle"))'></div>

    <div class="right-bottom-section">
        <h4>F√°jl El≈ën√©zet</h4>
        <textarea readonly class="preview-box">@_previewContent</textarea>
    </div>

    <div class="bottom-actions">
        <button @onclick="ProcessGitDiffAsync" disabled="@(!AppState.IsGitRepository)">Git K√ºl√∂nbs√©gek</button>
        <button @onclick="ShowClarificationDialog">Tiszt√°zand√≥ k√©rd√©sek v√°g√≥lapr√≥l</button>
        <button @onclick="ProcessChangesFromClipboardAsync">V√°ltoz√°sok V√°g√≥lapr√≥l</button>
        <div>
            <label><input type="checkbox" @bind="_includePromptInCopy" />Prompt</label>
            <label><input type="checkbox" @bind="_includeGlobalPrefixInCopy" />Glob√°lis</label>
            <button class="copy-button" @onclick="CopyToClipboard">M√°sol√°s v√°g√≥lapra</button>
            <button class="copy-button" @onclick="ProcessWithOpenRouterAsync" disabled="@(string.IsNullOrWhiteSpace(AppState.OpenRouterApiKey))" title="V√°ltoztat√°si javaslat k√©r√©se az OpenRouter-t≈ël">OR Javaslat</button>
        </div>
    </div>
</div>

<ClarificationDialog IsVisible="_isClarificationDialogVisible" 
                     ClipboardText="@_clarificationDialogText" 
                     OnClose="OnClarificationDialogClose" 
                     OnGenerateRefinedPrompt="HandleGenerateRefinedPrompt" />