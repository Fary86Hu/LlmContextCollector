@inject AppState AppState
@inject SettingsService SettingsService

@if (IsVisible)
{
    <div class="modal-backdrop">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3>Beállítások</h3>
                <button class="close-btn" @onclick="Close">&times;</button>
            </div>
            <div class="modal-body">
                <h4>Groq LLM Beállítások</h4>
                <div class="form-section">
                    <div class="form-group">
                        <label for="groq-apiurl">API URL:</label>
                        <input id="groq-apiurl" type="text" @bind="AppState.GroqApiUrl" placeholder="https://api.groq.com/openai/v1/"/>
                    </div>
                    <div class="form-group">
                        <label for="groq-model">Modell:</label>
                        <input id="groq-model" type="text" @bind="AppState.GroqModel" />
                    </div>
                    <div class="form-group">
                        <label for="groq-apikey">API Kulcs:</label>
                        <input id="groq-apikey" type="password" @bind="AppState.GroqApiKey" placeholder="gsk_..."/>
                    </div>
                    <div class="form-group">
                        <label for="groq-maxtokens">Max. kimeneti token:</label>
                        <input id="groq-maxtokens" type="number" min="64" max="8192" @bind="AppState.GroqMaxOutputTokens" />
                    </div>
                </div>

                <h4>OpenRouter API Beállítások</h4>
                <div class="form-section">
                    <div class="form-group">
                        <label for="or-apikey">API Kulcs:</label>
                        <input id="or-apikey" type="password" @bind="AppState.OpenRouterApiKey" placeholder="sk-or-..." />
                    </div>
                    <div class="form-group">
                        <label for="or-model">Modell:</label>
                        <input id="or-model" type="text" @bind="AppState.OpenRouterModel" />
                    </div>
                    <div class="form-group">
                        <label for="or-siteurl">Site URL (opcionális):</label>
                        <input id="or-siteurl" type="text" @bind="AppState.OpenRouterSiteUrl" placeholder="https://sajat-oldal.hu" />
                    </div>
                    <div class="form-group">
                        <label for="or-sitename">Site Name (opcionális):</label>
                        <input id="or-sitename" type="text" @bind="AppState.OpenRouterSiteName" placeholder="Saját Projekt" />
                    </div>
                </div>

                <h4>Lokális Ollama Beállítások</h4>
                <div class="form-section">
                    <div class="form-group">
                        <label for="ollama-url">API URL:</label>
                        <input id="ollama-url" type="text" @bind="AppState.OllamaApiUrl" placeholder="http://localhost:11434/v1/" />
                    </div>
                    <div class="form-group">
                        <label for="ollama-model">Modell neve:</label>
                        <input id="ollama-model" type="text" @bind="AppState.OllamaModel" placeholder="qwen3:4b-instruct" />
                    </div>
                </div>
                
                <h4>Keresés / Embedding Beállítások</h4>
                <div class="form-section">
                     <div class="form-group" style="flex-direction: row; align-items: center; justify-content: flex-start; gap: 10px;">
                        <input id="ollama-embed-use" type="checkbox" @bind="AppState.UseOllamaEmbeddings" style="width: auto; margin: 0;" />
                        <label for="ollama-embed-use" style="margin: 0; cursor: pointer;">Lokális Ollama használata Embeddinghez</label>
                    </div>
                    @if (AppState.UseOllamaEmbeddings)
                    {
                        <div class="form-group">
                            <label for="ollama-embed-model">Embedding Modell:</label>
                            <input id="ollama-embed-model" type="text" @bind="AppState.OllamaEmbeddingModel" placeholder="nomic-embed-text" />
                            <small>Győződj meg róla, hogy a modell le van töltve (`ollama pull nomic-embed-text`)</small>
                        </div>
                    }
                    else
                    {
                        <div class="hint-text">
                            A beépített (ONNX) modellt használja. Ha az nincs telepítve, a keresés nem fog működni.
                        </div>
                    }
                </div>

            </div>
            <div class="modal-footer">
                <button @onclick="Close">Mégsem</button>
                <button class="primary" @onclick="SaveChanges">Mentés</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    private async Task SaveChanges()
    {
        var settings = new Settings
        {
            GroqApiKey = AppState.GroqApiKey,
            GroqModel = AppState.GroqModel,
            GroqMaxOutputTokens = AppState.GroqMaxOutputTokens,
            GroqApiUrl = AppState.GroqApiUrl,
            OpenRouterApiKey = AppState.OpenRouterApiKey,
            OpenRouterModel = AppState.OpenRouterModel,
            OpenRouterSiteUrl = AppState.OpenRouterSiteUrl,
            OpenRouterSiteName = AppState.OpenRouterSiteName,
            OllamaApiUrl = AppState.OllamaApiUrl,
            OllamaModel = AppState.OllamaModel,
            UseOllamaEmbeddings = AppState.UseOllamaEmbeddings,
            OllamaEmbeddingModel = AppState.OllamaEmbeddingModel
        };
        await SettingsService.SaveSettingsAsync(settings);
        AppState.StatusText = "Beállítások mentve.";
        await Close();
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }
}