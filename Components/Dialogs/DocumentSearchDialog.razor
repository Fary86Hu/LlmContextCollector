@using LlmContextCollector.Models
@using System.IO

@if (IsVisible)
{
    <div class="modal-backdrop">
        <div class="modal-dialog search-dialog">
            <div class="modal-header">
                <h3>Szemantikus Keresés</h3>
                <button class="close-btn" @onclick="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="search-dialog-top-pane">
                    <textarea class="search-prompt-editor" placeholder="Keresési prompt (a fő promptot használja, ha üres)..." @bind="_searchPrompt"></textarea>
                    <div class="search-controls">
                        <div class="search-options">
                            <span>Keresés itt:</span>
                            <label><input type="checkbox" @bind="_searchInProgramFiles" /> Programfájlok</label>
                            <label><input type="checkbox" @bind="_searchInOtherDocuments" /> Egyéb dokumentumok</label>
                        </div>
                        <button @onclick="ExecuteSearch" disabled="@_isSearching" style="margin-right: 5px;">
                            @if (_isSearching && !_isAgentMode)
                            {
                                <span class="spinner"></span>
                                <span>Keresés...</span>
                            }
                            else
                            {
                                <span>Keresés</span>
                            }
                        </button>
                        <button @onclick="ExecuteAgentSearch" disabled="@_isSearching" class="secondary" title="Agent alapú keresés (Max 4 kör)">
                            @if (_isSearching && _isAgentMode)
                            {
                                <span class="spinner"></span>
                                <span>@_agentStatus</span>
                            }
                            else
                            {
                                <span>Agent Keresés</span>
                            }
                        </button>
                    </div>
                </div>
                <div class="search-dialog-main-pane">
                    @if (_isAgentMode)
                    {
                        <div class="agent-console-pane">
                            <div class="agent-console-header">
                                <strong>Agent Live Console</strong>
                                <button class="secondary" @onclick="() => _agentLogs.Clear()">Törlés</button>
                            </div>
                            <div id="agent-log-container" class="agent-log-content">
                                @foreach (var log in _agentLogs)
                                {
                                    <div class="agent-log-entry @(log.Type.Contains("AI") ? "ai" : "user")">
                                        <div class="log-header" @onclick="() => ToggleLog(log)">
                                            <span class="log-toggle-icon">@(log.IsExpanded ? "▼" : "▶")</span>
                                            <span class="log-label">@log.Type</span>
                                        </div>
                                        
                                        @if (log.IsExpanded)
                                        {
                                            <div class="log-text expanded">@log.Text</div>
                                        }
                                        else
                                        {
                                            <div class="log-text collapsed" @onclick="() => ToggleLog(log)">
                                                @GetLogPreview(log)
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    <div class="search-context-pane">
                        <strong>Keresési kontextus</strong>
                        <div class="search-context-list">
                            @if (!_contextFilesForSearch.Any())
                            {
                                <div class="editor-placeholder">Nincs fájl a fő kontextus listában.</div>
                            }
                            @foreach (var file in _contextFilesForSearch)
                            {
                                <div @key="file.FilePath" class="search-context-item" title="@file.FilePath">
                                    <label>
                                        <input type="checkbox" @bind="file.IsUsedForContext" />
                                        <span class="search-context-path">@Path.GetFileName(file.FilePath)</span>
                                    </label>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="search-results-pane">
                        <strong>Találatok (@_searchResults.Count)</strong>
                        <div class="search-results-list">
                            @if (!_searchResults.Any() && !_isSearching)
                            {
                                <div class="editor-placeholder">Nincs találat, vagy még nem indított keresést.</div>
                            }
                            @foreach (var vm in _searchResults)
                            {
                                <div @key="vm.Result.FilePath" class="search-result-item @(_selectedResult == vm.Result ? "selected" : "")" @onclick="() => SelectResult(vm.Result)">
                                    <input type="checkbox" @bind="vm.IsSelected" @onclick:stopPropagation />
                                    <span class="search-result-score">@vm.Result.Score.ToString("F2")</span>
                                    <span class="search-result-path">@vm.Result.FilePath</span>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="search-preview-pane">
                        <strong>Előnézet</strong>
                        <textarea readonly class="preview-box">@_previewContent</textarea>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button @onclick="Close">Mégsem</button>
                <button class="primary" @onclick="Accept" disabled="@(!_searchResults.Any(vm => vm.IsSelected))">Kijelöltek Hozzáadása</button>
            </div>
        </div>
    </div>
}