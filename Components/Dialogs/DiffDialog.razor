@using LlmContextCollector.Models
@using LlmContextCollector.Utils
@using LlmContextCollector.Services
@inject IClipboard Clipboard
@inject AppState AppState
@inject GitWorkflowService GitWorkflowService
@inject GitSuggestionService GitSuggestionService
@inject IJSRuntime JSRuntime
@implements IDisposable

@if (IsVisible)
{
    <div class="modal-backdrop" 
         @onclick="HideContextMenu" 
         @onmousemove="OnMouseMove" 
         @onmouseup="StopPaneResize"
         @onmouseleave="StopPaneResize">
        <div class="modal-dialog diff-dialog">
            <div class="modal-header">
                <h3>V√°ltoz√°sok Elemz√©se √©s Elfogad√°sa</h3>
                <div class="header-controls">
                    @if (!string.IsNullOrEmpty(FullLlmResponse))
                    {
                        <button @onclick="ToggleFullResponseView">
                            @(_isFullResponseView ? "Vissza a V√°ltoz√°sokhoz" : "Teljes LLM V√°lasz")
                        </button>
                    }
                    <button class="close-btn" @onclick="Close">&times;</button>
                </div>
            </div>
            <div class="modal-body diff-body">
                <div class="diff-left-pane" style="width: @(_leftPaneWidthPercent.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%;">
                    @if (_isGitDiffMode)
                    {
                        <div class="diff-selector-box">
                            <strong>K√ºl√∂nbs√©gek forr√°sa:</strong>
                            <div class="diff-options">
                                <label><input type="radio" name="diff-mode" @onchange="() => _selectedDiffMode = GitWorkflowService.DiffMode.Uncommitted" checked="@(_selectedDiffMode == GitWorkflowService.DiffMode.Uncommitted)" /> Jelenlegi v√°ltoz√°sok</label>
                                <label><input type="radio" name="diff-mode" @onchange="() => _selectedDiffMode = GitWorkflowService.DiffMode.SinceBranchCreation" checked="@(_selectedDiffMode == GitWorkflowService.DiffMode.SinceBranchCreation)" /> Branch nyit√°sa √≥ta</label>
                                <label><input type="radio" name="diff-mode" @onchange="() => _selectedDiffMode = GitWorkflowService.DiffMode.AgainstBranch" checked="@(_selectedDiffMode == GitWorkflowService.DiffMode.AgainstBranch)" /> M√°sik branch-hez k√©pest</label>
                            </div>
                            @if (_selectedDiffMode == GitWorkflowService.DiffMode.AgainstBranch)
                            {
                                <select @bind="_selectedTargetBranch">
                                    @foreach (var branch in _allBranches)
                                    {
                                        <option value="@branch">@branch</option>
                                    }
                                </select>
                            }
                            <button @onclick="LoadSelectedDiffsAsync" disabled="@_isLoadingDiffs">
                                @if (_isLoadingDiffs)
                                {
                                    <span class="spinner-small"></span>
                                }
                                else
                                {
                                    <span>K√ºl√∂nbs√©gek mutat√°sa</span>
                                }
                            </button>
                        </div>
                    }

                    <div class="suggestion-box">
                        <div class="suggestion-header">
                            <strong>@(_hasSuggestions ? "Javaslatok:" : "Git M≈±veletek")</strong>
                            @if (_isGitDiffMode)
                            {
                                <button class="refresh-btn" @onclick="RefreshSuggestionsAsync" title="Javaslatok friss√≠t√©se" disabled="@_isRefreshingSuggestions">
                                    @if (_isRefreshingSuggestions)
                                    {
                                        <span class="spinner-small"></span>
                                    }
                                    else
                                    {
                                        <span>üîÑ</span>
                                    }
                                </button>
                            }
                        </div>
                        <div class="suggestion-item">
                            <label>Branch:</label>
                            <input type="text" @bind="_suggestedBranch" placeholder="pl. feature/uj-funkcio" />
                            @if (_hasSuggestions)
                            {
                                <button @onclick="() => CopyToClipboard(_suggestedBranch)">M√°sol</button>
                            }
                        </div>
                        <div class="suggestion-item">
                            <label>Commit:</label>
                            <textarea rows="5" @bind="_suggestedCommit" placeholder="pl. feat: √öj funkci√≥ implement√°l√°sa..."></textarea>
                            @if (_hasSuggestions)
                            {
                                <button @onclick="() => CopyToClipboard(_suggestedCommit)">M√°sol</button>
                            }
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(_globalExplanationText))
                    {
                        <div class="diff-global-explanation">
                            <strong>Glob√°lis Magyar√°zat:</strong>
                            <pre>@_globalExplanationText</pre>
                        </div>
                    }
                    <strong>Feldolgozott f√°jlok: (@_localDiffResults.Count)</strong>
                    <fieldset class="file-list-fieldset" disabled="@_isFullResponseView">
                        <div class="diff-file-list">
                            @foreach (var result in _localDiffResults)
                            {
                                <div @key="result.Path"
                                     class="diff-file-item @GetStatusClass(result) @(_selectedResult != null && _selectedResult.Path == result.Path ? "selected" : "")"
                                     @onclick="() => SelectResult(result)">
                                    <input type="checkbox" @bind="result.IsSelectedForAccept" @onclick:stopPropagation />
                                    <span class="status-badge @GetStatusClass(result)">@GetStatusText(result)</span>
                                    <span class="file-path-text" title="@result.Path">@result.Path</span>
                                    
                                    <div class="item-actions">
                                        @if (!string.IsNullOrEmpty(result.Explanation))
                                        {
                                            <span class="comment-indicator" title="Van magyar√°zat">üí¨</span>
                                        }
                                        <button class="reset-btn" @onclick="() => RevertFile(result)" @onclick:stopPropagation title="V√°ltoz√°sok eldob√°sa / vissza√°ll√≠t√°sa">
                                            ‚Ü©Ô∏è
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>

                    </fieldset>
                </div>

                <div class="diff-splitter" @onmousedown="StartPaneResize"></div>

                <div class="diff-right-pane" style="width: @((100 - _leftPaneWidthPercent).ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%;">
                    @if (_isFullResponseView)
                    {
                        <div class="full-response-view">
                            <strong>Teljes LLM v√°lasz:</strong>
                            <textarea readonly>@FullLlmResponse</textarea>
                        </div>
                    }
                    else if (_selectedResult != null)
                    {
                         @if (!string.IsNullOrEmpty(_selectedResult.Explanation))
                        {
                            <div class="file-explanation-box">
                                <strong>@_selectedResult.Path - Magyar√°zat:</strong>
                                <p>@_selectedResult.Explanation</p>
                            </div>
                        }
                        
                        <div class="diff-view-switcher">
                            <div class="view-modes">
                                <label>
                                    <input type="radio" name="diff-view" value="unified" checked="@(_viewMode == "unified")" @onchange="@(() => SetViewMode("unified"))" />
                                    Egys√©ges n√©zet (Olvas√°s)
                                </label>
                                <label>
                                    <input type="radio" name="diff-view" value="sbs" checked="@(_viewMode == "sbs")" @onchange="@(() => SetViewMode("sbs"))" />
                                    Side-by-Side (Szerkeszt√©s)
                                </label>
                            </div>
                        </div>

                        @if (_viewMode == "sbs")
                        {
                            <div id="sbs-container" class="diff-editor-container" style="gap: 0;">
                                <div class="editor-pane" style="flex: none; width: @(_sbsLeftPaneWidthPercent.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%">
                                    <div class="editor-header">Eredeti (Olvas√°s - Piros: T√∂r√∂lt)</div>
                                    <div id="editor-left-display" class="editor-display-container">
                                        @foreach (var item in _sbsLeftLines)
                                        {
                                            @if (item.IsGap)
                                            {
                                                <div class="sbs-gap" style="height: @(item.HeightInLines * 1.5)em;"></div>
                                            }
                                            else
                                            {
                                                <div class="sbs-line-item @item.CssClass">@item.Content</div>
                                            }
                                        }
                                    </div>
                                    @* Scrollbar markers for the Left Pane *@
                                    <div class="diff-scrollbar-track">
                                        @foreach (var marker in _sbsLeftMarkers)
                                        {
                                            <div class="diff-marker @marker.Type" style="top: @marker.TopPercent.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)%"></div>
                                        }
                                    </div>
                                </div>
                                
                                <div class="diff-splitter" @onmousedown="StartSbsResize"></div>
                                
                                <div class="editor-pane" style="flex: none; width: @((100 - _sbsLeftPaneWidthPercent).ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%">
                                    <div class="editor-header">√öj / M√≥dos√≠tott (Szerkeszthet≈ë - Z√∂ld: √öj)</div>
                                    <div class="layered-editor-container">
                                        <div id="editor-backdrop" class="editor-backdrop">
                                            @foreach (var isNew in _editorLineHighlights)
                                            {
                                                <div class="line-bg @(isNew ? "is-new" : "")">&nbsp;</div>
                                            }
                                        </div>
                                        <textarea id="editor-textarea" 
                                                  class="editor-textarea"
                                                  @bind="_selectedResult.NewContent" 
                                                  @bind:event="oninput" 
                                                  @onkeyup="OnContentChanged"
                                                  @onscroll="SyncScroll"></textarea>
                                                  
                                        <div class="diff-scrollbar-track">
                                            @foreach (var marker in _sbsDiffMarkers)
                                            {
                                                <div class="diff-marker @marker.Type" style="top: @marker.TopPercent.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)%"></div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="editor-hint">
                                <small>A bal oldali n√©zet igazodik a m√≥dos√≠t√°sokhoz. T√∂r√∂lt sorok pirossal, besz√∫rt sorok helye √ºresen.</small>
                            </div>
                        }
                        else
                        {
                            <div class="diff-content-wrapper">
                                <div class="diff-content unified-diff-list">
                                    @foreach (var line in _unifiedDiffLines)
                                    {
                                        <div class="diff-row @GetDiffLineClass(line)" @oncontextmenu="(e) => ShowLineContextMenu(e, line)" @oncontextmenu:preventDefault>
                                            <span class="diff-marker-text">@GetDiffLineMarker(line)</span>
                                            <span class="diff-text">@line.Content</span>
                                        </div>
                                    }
                                </div>
                                <div class="diff-scrollbar-track">
                                    @foreach (var marker in _unifiedDiffMarkers)
                                    {
                                        <div class="diff-marker @marker.Type" style="top: @marker.TopPercent.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)%"></div>
                                    }
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="editor-placeholder">V√°lassz egy f√°jlt a v√°ltoz√°sok megtekint√©s√©hez. Vagy v√°lassz m√°sik k√ºl√∂nbs√©g forr√°st.</div>
                    }
                </div>

            </div>
            <div class="modal-footer">
                <span>@($"{_localDiffResults.Count(r => r.IsSelectedForAccept)} f√°jl kijel√∂lve")</span>
                <button @onclick="Close">Bez√°r√°s</button>
                <button class="primary" @onclick="AcceptSelectedChanges" disabled="@(!_localDiffResults.Any(r => r.IsSelectedForAccept))">
                    Kijel√∂ltek elfogad√°sa
                </button>
                @{
                    var onCorrectBranch = !string.IsNullOrWhiteSpace(_suggestedBranch) && AppState.CurrentGitBranch == _suggestedBranch;
                }
                <button class="primary" @onclick="CreateBranch" disabled="@(string.IsNullOrWhiteSpace(_suggestedBranch) || onCorrectBranch)">
                    Branch L√©trehoz√°sa
                </button>
                <button class="primary" @onclick="Commit" disabled="@(string.IsNullOrWhiteSpace(_suggestedCommit) || !_localDiffResults.Any(r => r.IsSelectedForAccept))">
                    Commit
                </button>
                <button class="primary commit-btn" @onclick="Push">
                    Push
                </button>
            </div>
        </div>
    </div>
}

@if (_showContextMenu)
{
    <div class="context-menu" style="@($"top: {_contextMenuY}px; left: {_contextMenuX}px;")" @onclick:stopPropagation>
        <div class="context-menu-item" @onclick="ApplyLineRevert">
            V√°ltoztat√°s visszavon√°sa (Reset Line)
        </div>
    </div>
}

<script>
    window.syncEditorScroll = (textareaId, backdropId, leftDisplayId) => {
        const ta = document.getElementById(textareaId);
        const bd = document.getElementById(backdropId);
        const ld = document.getElementById(leftDisplayId);
        if (ta) {
            if (bd) {
                bd.scrollTop = ta.scrollTop;
                bd.scrollLeft = ta.scrollLeft;
            }
            if (ld) {
                // Simple scrollTop sync. 
                // Note: Complex alignment with deleted lines might cause minor drift unless line-heights are perfectly strictly equal.
                ld.scrollTop = ta.scrollTop;
            }
        }
    };
    window.getElementBoundingClientRect = (elementId) => {
        const el = document.getElementById(elementId);
        if (el) {
            const rect = el.getBoundingClientRect();
            return { left: rect.left, width: rect.width };
        }
        return null;
    };
</script>

@code {
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public string GlobalExplanation { get; set; } = string.Empty;

    [Parameter]
    public string FullLlmResponse { get; set; } = string.Empty;

    [Parameter]
    public List<DiffResult>? DiffResults { get; set; }

    [Parameter]
    public EventCallback<List<DiffResult>> OnAccept { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback<string> OnCreateBranch { get; set; }

    [Parameter]
    public EventCallback<CommitAndPushArgs> OnCommit { get; set; }

    [Parameter]
    public EventCallback<CommitAndPushArgs> OnPush { get; set; }

    private List<DiffResult> _localDiffResults = new();
    private DiffResult? _selectedResult;
    private string _viewMode = "unified";
    
    // Unified View Data
    private List<DiffUtility.DiffLineItem> _unifiedDiffLines = new();
    private List<DiffMarkerInfo> _unifiedDiffMarkers = new();

    // SBS View Data
    private record DiffMarkerInfo(string Type, double TopPercent);
    private List<DiffMarkerInfo> _sbsDiffMarkers = new();      // Right pane markers
    private List<DiffMarkerInfo> _sbsLeftMarkers = new();      // Left pane markers
    
    private record SbsLeftItem(string Content, bool IsGap, int HeightInLines, string CssClass);
    private List<SbsLeftItem> _sbsLeftLines = new();

    private string _suggestedBranch = string.Empty;
    private string _suggestedCommit = string.Empty;
    private string _globalExplanationText = string.Empty;
    private bool _hasSuggestions = false;
    private bool _isFullResponseView = false;
    private bool _isGitDiffMode = false;


    private GitWorkflowService.DiffMode _selectedDiffMode = GitWorkflowService.DiffMode.Uncommitted;
    private List<string> _allBranches = new();
    private string? _selectedTargetBranch;
    private bool _isLoadingDiffs = false;
    private bool _isRefreshingSuggestions = false;
    
    private bool _prevIsVisible = false;
    
    private bool _showContextMenu = false;
    private double _contextMenuX;
    private double _contextMenuY;
    private DiffUtility.DiffLineItem? _contextMenuTargetLine;

    // --- Resizing ---
    private double _leftPaneWidthPercent = 35.0;
    private bool _isResizingPane = false;
    private double _windowWidth = 0;

    // --- SBS Resizing ---
    private double _sbsLeftPaneWidthPercent = 50.0;
    private bool _isResizingSbs = false;
    private double _sbsContainerLeft = 0;
    private double _sbsContainerWidth = 0;
    
    // --- Editor Highlights ---
    private List<bool> _editorLineHighlights = new();


    protected override void OnInitialized()
    {
        AppState.PropertyChanged += OnAppStateChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !_prevIsVisible)
        {
            _localDiffResults = DiffResults?.ToList() ?? new();
            _isGitDiffMode = string.IsNullOrEmpty(FullLlmResponse);

            if (_isGitDiffMode)
            {
                _suggestedBranch = string.Empty;
                _suggestedCommit = string.Empty;
                _hasSuggestions = false;
                _globalExplanationText = string.Empty; 
                await LoadBranchesAsync();
            }
            else
            {
                ParseGlobalExplanation();
            }

            if (_selectedResult == null || !_localDiffResults.Any(d => d.Path == _selectedResult.Path))
            {
                SelectResult(_localDiffResults.FirstOrDefault());
            }
        }
        
        _prevIsVisible = IsVisible;
    }

    private async void OnAppStateChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        if (e.PropertyName == nameof(AppState.CurrentGitBranch))
        {
            await InvokeAsync(StateHasChanged);
        }
    }
    
    // --- Resizing Logic ---
    private async Task StartPaneResize(MouseEventArgs e)
    {
        _isResizingPane = true;
        try
        {
            _windowWidth = await JSRuntime.InvokeAsync<double>("eval", "window.innerWidth");
        }
        catch
        {
            _windowWidth = 1920;
        }
    }

    private async Task StartSbsResize(MouseEventArgs e)
    {
        _isResizingSbs = true;
        try
        {
            var rect = await JSRuntime.InvokeAsync<BoundingRect>("getElementBoundingClientRect", "sbs-container");
            if (rect != null)
            {
                _sbsContainerLeft = rect.Left;
                _sbsContainerWidth = rect.Width;
            }
        }
        catch
        {
            _isResizingSbs = false;
        }
    }

    private void StopPaneResize(MouseEventArgs e)
    {
        _isResizingPane = false;
        _isResizingSbs = false;
    }

    private void OnMouseMove(MouseEventArgs e)
    {
        if (_isResizingPane && _windowWidth > 0)
        {
            var percent = (e.ClientX / _windowWidth) * 100;
            if (percent < 10) percent = 10;
            if (percent > 90) percent = 90;
            
            var dialogWidth = _windowWidth * 0.95;
            var dialogLeft = (_windowWidth - dialogWidth) / 2;
            var relX = e.ClientX - dialogLeft;
            var relPercent = (relX / dialogWidth) * 100;
            
            if (relPercent < 15) relPercent = 15;
            if (relPercent > 85) relPercent = 85;

            _leftPaneWidthPercent = relPercent;
        }
        else if (_isResizingSbs && _sbsContainerWidth > 0)
        {
            var relX = e.ClientX - _sbsContainerLeft;
            var percent = (relX / _sbsContainerWidth) * 100;
            
            if (percent < 10) percent = 10;
            if (percent > 90) percent = 90;
            
            _sbsLeftPaneWidthPercent = percent;
        }
    }
    
    private record BoundingRect(double Left, double Width);

    // --- Editor Logic ---
    private void UpdateEditorHighlights()
    {
        _editorLineHighlights.Clear();
        if (_selectedResult == null) return;

        var oldLines = _selectedResult.OldContent.Replace("\r\n", "\n").Split('\n');
        var newLines = _selectedResult.NewContent.Replace("\r\n", "\n").Split('\n');
        var opcodes = DiffUtility.GetOpcodes(oldLines, newLines);

        var flags = new bool[newLines.Length];

        foreach (var op in opcodes)
        {
            if (op.Tag == 'i' || op.Tag == 'r')
            {
                for (int j = op.J1; j < op.J2; j++)
                {
                    if (j < flags.Length) flags[j] = true;
                }
            }
        }
        
        _editorLineHighlights.AddRange(flags);
    }

    private async Task SyncScroll()
    {
        await JSRuntime.InvokeVoidAsync("syncEditorScroll", "editor-textarea", "editor-backdrop", "editor-left-display");
    }

    // --- Existing Logic ---

    private void ShowLineContextMenu(MouseEventArgs e, DiffUtility.DiffLineItem line)
    {
        if (line.Type == DiffUtility.DiffLineType.Context) return;

        _contextMenuX = e.ClientX;
        _contextMenuY = e.ClientY;
        _contextMenuTargetLine = line;
        _showContextMenu = true;
    }

    private void HideContextMenu()
    {
        _showContextMenu = false;
        _contextMenuTargetLine = null;
    }

    private void ApplyLineRevert()
    {
        if (_contextMenuTargetLine == null || _selectedResult == null)
        {
            HideContextMenu();
            return;
        }

        var targetLine = _contextMenuTargetLine;
        var currentNewContent = _selectedResult.NewContent.Replace("\r\n", "\n").Split('\n').ToList();

        if (targetLine.Type == DiffUtility.DiffLineType.Add && targetLine.NewIndex.HasValue)
        {
            if (targetLine.NewIndex.Value < currentNewContent.Count)
            {
                currentNewContent.RemoveAt(targetLine.NewIndex.Value);
            }
        }
        else if (targetLine.Type == DiffUtility.DiffLineType.Delete)
        {
            int insertIndex = 0;
            int lineIndexInView = _unifiedDiffLines.IndexOf(targetLine);
            
            if (lineIndexInView > 0)
            {
                for (int i = lineIndexInView - 1; i >= 0; i--)
                {
                    var prevLine = _unifiedDiffLines[i];
                    if (prevLine.NewIndex.HasValue)
                    {
                        insertIndex = prevLine.NewIndex.Value + 1;
                        break;
                    }
                }
            }

            if (insertIndex <= currentNewContent.Count)
            {
                currentNewContent.Insert(insertIndex, targetLine.Content);
            }
        }

        _selectedResult.NewContent = string.Join(Environment.NewLine, currentNewContent);
        
        if (_selectedResult.Status == DiffStatus.Deleted && !string.IsNullOrWhiteSpace(_selectedResult.NewContent))
        {
            _selectedResult.Status = DiffStatus.Modified;
        }
        
        GenerateDiffView();
        HideContextMenu();
    }

    public void Dispose()
    {
        AppState.PropertyChanged -= OnAppStateChanged;
    }

    private void ToggleFullResponseView()
    {
        _isFullResponseView = !_isFullResponseView;
    }

    private async Task LoadBranchesAsync()
    {
        _allBranches = await GitWorkflowService.GetBranchesAsync();
        if (_allBranches.Any())
        {
            _selectedTargetBranch = _allBranches.FirstOrDefault(b => b == "main" || b == "master") ?? _allBranches.First();
        }
    }

    private async Task LoadSelectedDiffsAsync()
    {
        _isLoadingDiffs = true;
        StateHasChanged();
        try
        {
            _localDiffResults = await GitWorkflowService.GetDiffsAsync(_selectedDiffMode, _selectedTargetBranch);
            _suggestedBranch = string.Empty;
            _suggestedCommit = string.Empty;
            _hasSuggestions = false;
            SelectResult(_localDiffResults.FirstOrDefault());
        }
        finally
        {
            _isLoadingDiffs = false;
            StateHasChanged();
        }
    }

    private async Task RefreshSuggestionsAsync()
    {
        if (!_localDiffResults.Any())
        {
            AppState.StatusText = "Nincsenek k√ºl√∂nbs√©gek, amik alapj√°n javaslatot lehetne gener√°lni.";
            return;
        }

        _isRefreshingSuggestions = true;
        StateHasChanged();

        try
        {
            var (branch, commit) = await GitSuggestionService.GetSuggestionsAsync(_localDiffResults, _globalExplanationText);
            _suggestedBranch = branch ?? "hiba-a-javaslatban";
            _suggestedCommit = commit ?? "Hiba t√∂rt√©nt a commit √ºzenet gener√°l√°sakor.";
            _hasSuggestions = branch != null;
        }
        finally
        {
            _isRefreshingSuggestions = false;
            StateHasChanged();
        }
    }

    private void ParseGlobalExplanation()
    {
        _hasSuggestions = false;
        _suggestedBranch = string.Empty;
        _suggestedCommit = string.Empty;
        _globalExplanationText = GlobalExplanation;

        if (string.IsNullOrEmpty(GlobalExplanation)) return;

        var branchMatch = System.Text.RegularExpressions.Regex.Match(GlobalExplanation, @"\[BRANCH_SUGGESTION\]([\s\S]*?)\[/BRANCH_SUGGESTION\]");
        var commitMatch = System.Text.RegularExpressions.Regex.Match(GlobalExplanation, @"\[COMMIT_SUGGESTION\]([\s\S]*?)\[/COMMIT_SUGGESTION\]");

        if (branchMatch.Success && commitMatch.Success)
        {
            _hasSuggestions = true;
            _suggestedBranch = branchMatch.Groups[1].Value.Trim();
            _suggestedCommit = commitMatch.Groups[1].Value.Trim();
            _globalExplanationText = System.Text.RegularExpressions.Regex.Replace(GlobalExplanation, @"\[BRANCH_SUGGESTION\][\s\S]*?\[/COMMIT_SUGGESTION\]\s*", "").Trim();
        }
    }

    private async Task CopyToClipboard(string text)
    {
        if (!string.IsNullOrEmpty(text))
        {
            await Clipboard.SetTextAsync(text);
        }
    }

    private void SelectResult(DiffResult? result)
    {
        _selectedResult = result;
        if (string.IsNullOrEmpty(_viewMode)) _viewMode = "unified";
        
        GenerateDiffView();
        
        if (_viewMode == "sbs")
        {
            UpdateEditorHighlights();
        }
    }

    private void SetViewMode(string newMode)
    {
        if (_viewMode == newMode) return;
        _viewMode = newMode;
        GenerateDiffView();
        
        if (_viewMode == "sbs")
        {
            UpdateEditorHighlights();
        }
    }

    private void OnContentChanged()
    {
        GenerateDiffView(); 
        UpdateEditorHighlights(); 
    }

    private void GenerateDiffView()
    {
        _unifiedDiffLines.Clear();
        _unifiedDiffMarkers.Clear();
        _sbsDiffMarkers.Clear();
        _sbsLeftMarkers.Clear();
        _sbsLeftLines.Clear();

        if (_selectedResult == null) return;

        _unifiedDiffLines = DiffUtility.GenerateDiffList(_selectedResult.OldContent, _selectedResult.NewContent);
        
        var oldText = _selectedResult.OldContent;
        var newText = _selectedResult.NewContent;

        var oldLines = oldText.Replace("\r\n", "\n").Split('\n');
        var newLines = newText.Replace("\r\n", "\n").Split('\n');
        var opcodes = DiffUtility.GetOpcodes(oldLines, newLines);

        GenerateUnifiedMarkers(opcodes);

        GenerateSbsData(opcodes, oldLines, newLines);
    }
    
    private void GenerateUnifiedMarkers(List<DiffUtility.DiffOpcode> opcodes)
    {
        double totalLines = opcodes.Sum(op => op.Tag switch
        {
            'e' => op.I2 - op.I1,
            'd' => op.I2 - op.I1,
            'i' => op.J2 - op.J1,
            'r' => (op.I2 - op.I1) + (op.J2 - op.J1),
            _ => 0
        });

        if (totalLines < 1) return;

        double currentLine = 0;
        foreach (var op in opcodes)
        {
            double linesInOp = 0;
            string? markerType = null;

            switch (op.Tag)
            {
                case 'e': linesInOp = op.I2 - op.I1; break;
                case 'd': linesInOp = op.I2 - op.I1; markerType = "del"; break;
                case 'i': linesInOp = op.J2 - op.J1; markerType = "add"; break;
                case 'r': linesInOp = (op.I2 - op.I1) + (op.J2 - op.J1); markerType = "replace"; break;
            }

            if (markerType != null)
            {
                _unifiedDiffMarkers.Add(new DiffMarkerInfo(markerType, (currentLine / totalLines) * 100));
            }
            currentLine += linesInOp;
        }
    }

    private void GenerateSbsData(List<DiffUtility.DiffOpcode> opcodes, string[] oldLines, string[] newLines)
    {
        // 1. Build Right Side Markers (based on New Content logic)
        double totalNewLines = newLines.Length;
        if (totalNewLines < 1) totalNewLines = 1;

        // 2. Build Left Side Content (_sbsLeftLines)
        foreach (var op in opcodes)
        {
            switch (op.Tag)
            {
                case 'e':
                    for (int i = op.I1; i < op.I2; i++)
                    {
                        _sbsLeftLines.Add(new SbsLeftItem(oldLines[i], false, 1, ""));
                    }
                    break;

                case 'd':
                    // Marker for Right Side (showing where delete happened relative to new content)
                    double delPosPercent = (op.J1 / totalNewLines) * 100;
                    _sbsDiffMarkers.Add(new DiffMarkerInfo("del", delPosPercent));

                    for (int i = op.I1; i < op.I2; i++)
                    {
                        _sbsLeftLines.Add(new SbsLeftItem(oldLines[i], false, 1, "sbs-del"));
                    }
                    break;

                case 'i':
                    // Marker for Right Side (Insert)
                    double insertStartPercent = (op.J1 / totalNewLines) * 100;
                    _sbsDiffMarkers.Add(new DiffMarkerInfo("add", insertStartPercent));
                    
                    // Add GAP to Left Side to maintain alignment
                    int lineCount = op.J2 - op.J1;
                    _sbsLeftLines.Add(new SbsLeftItem("", true, lineCount, ""));
                    break;

                case 'r':
                    // Marker for Right Side (Replace)
                    double replaceStartPercent = (op.J1 / totalNewLines) * 100;
                    _sbsDiffMarkers.Add(new DiffMarkerInfo("replace", replaceStartPercent));
                    
                    for (int i = op.I1; i < op.I2; i++)
                    {
                        _sbsLeftLines.Add(new SbsLeftItem(oldLines[i], false, 1, "sbs-del"));
                    }
                    int oldLen = op.I2 - op.I1;
                    int newLen = op.J2 - op.J1;
                    
                    // If new content is longer, we need a gap on the left to sync up
                    if (newLen > oldLen)
                    {
                         _sbsLeftLines.Add(new SbsLeftItem("", true, newLen - oldLen, ""));
                    }
                    break;
            }
        }

        // 3. Build Left Side Markers (based on the Visual Left Pane height including gaps)
        double totalLeftVisualLines = _sbsLeftLines.Sum(x => x.HeightInLines);
        if (totalLeftVisualLines < 1) totalLeftVisualLines = 1;

        double currentVisualLine = 0;
        foreach (var item in _sbsLeftLines)
        {
            if (item.IsGap)
            {
                // This gap corresponds to an insertion on the right. 
                // We mark it green on the left scrollbar to show "stuff happens here".
                double top = (currentVisualLine / totalLeftVisualLines) * 100;
                _sbsLeftMarkers.Add(new DiffMarkerInfo("add", top));
            }
            else if (!string.IsNullOrEmpty(item.CssClass) && item.CssClass.Contains("sbs-del"))
            {
                // Deleted content
                double top = (currentVisualLine / totalLeftVisualLines) * 100;
                _sbsLeftMarkers.Add(new DiffMarkerInfo("del", top));
            }
            
            currentVisualLine += item.HeightInLines;
        }
    }


    private string GetDiffLineClass(DiffUtility.DiffLineItem line)
    {
        return line.Type switch
        {
            DiffUtility.DiffLineType.Add => "add",
            DiffUtility.DiffLineType.Delete => "del",
            _ => ""
        };
    }

    private string GetDiffLineMarker(DiffUtility.DiffLineItem line)
    {
        return line.Type switch
        {
            DiffUtility.DiffLineType.Add => "+",
            DiffUtility.DiffLineType.Delete => "-",
            _ => " "
        };
    }


    private async Task AcceptSelectedChanges()
    {
        var accepted = _localDiffResults?.Where(r => r.IsSelectedForAccept).ToList();
        if (accepted != null && accepted.Any())
        {
            await OnAccept.InvokeAsync(accepted);
        }
    }

    private async Task CreateBranch()

    {
        if (!string.IsNullOrWhiteSpace(_suggestedBranch))
        {
            await OnCreateBranch.InvokeAsync(_suggestedBranch);
        }
    }

    private async Task Commit()
    {
        var accepted = _localDiffResults?.Where(r => r.IsSelectedForAccept).ToList();
        if (accepted != null && accepted.Any() && !string.IsNullOrWhiteSpace(_suggestedCommit))
        {
            var args = new CommitAndPushArgs(_suggestedBranch, _suggestedCommit, accepted);
            await OnCommit.InvokeAsync(args);
        }
    }

    private async Task Push()
    {
        var branchToPush = AppState.CurrentGitBranch;
        if (!string.IsNullOrWhiteSpace(branchToPush))
        {
            var accepted = _localDiffResults?.Where(r => r.IsSelectedForAccept).ToList() ?? new List<DiffResult>();
            var args = new CommitAndPushArgs(branchToPush, _suggestedCommit, accepted);
            await OnPush.InvokeAsync(args);
        }
    }

    private string GetStatusText(DiffResult result)
    {
        return result.Status switch
        {
            DiffStatus.NewFromModified => "√öJ (m√≥dos√≠tottk√©nt jel√∂lve)",
            DiffStatus.Deleted => "T√ñR√ñLT",
            _ => result.Status.ToString().ToUpper()
        };
    }

    private string GetStatusClass(DiffResult result)
    {
        return result.Status switch
        {
            DiffStatus.New => "new",
            DiffStatus.Modified => "modified",
            DiffStatus.Deleted => "deleted",
            DiffStatus.Accepted => "accepted",
            DiffStatus.Error => "error",
            DiffStatus.NewFromModified => "new",
            _ => ""
        };
    }

    private async Task Close()
    {
        _selectedResult = null;
        _isFullResponseView = false;
        _localDiffResults.Clear();
        _allBranches.Clear();
        await OnClose.InvokeAsync();
    }


    private async Task RevertFile(DiffResult result)
    {
        if (_isGitDiffMode)
        {
            bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Biztosan vissza√°ll√≠tod/t√∂rl√∂d a f√°jlt?\n\n{result.Path}\n\nEz a m≈±velet NEM vonhat√≥ vissza!");
            if (!confirmed) return;

            try
            {
                await GitWorkflowService.DiscardFileChangesAsync(result);
                if (_selectedResult == result)
                {
                    _selectedResult = null;
                    GenerateDiffView();
                }
                await LoadSelectedDiffsAsync();
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Hiba a vissza√°ll√≠t√°s sor√°n: {ex.Message}");
            }
        }
        else
        {
            _localDiffResults.Remove(result);
            if (_selectedResult == result)
            {
                _selectedResult = null;
                GenerateDiffView();
            }
            StateHasChanged();
        }
    }
}