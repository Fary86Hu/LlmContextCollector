@using LlmContextCollector.Models
@using LlmContextCollector.Utils
@using LlmContextCollector.Services
@using System.Text.RegularExpressions
@inject IClipboard Clipboard
@inject AppState AppState
@inject GitWorkflowService GitWorkflowService
@inject GitSuggestionService GitSuggestionService
@inject IJSRuntime JSRuntime
@implements IDisposable

@if (IsVisible)
{
    <div class="modal-backdrop" 
         @onclick="HideContextMenu" 
         @onmousemove="OnMouseMove" 
         @onmouseup="StopPaneResize"
         @onmouseleave="StopPaneResize">
        <div class="modal-dialog diff-dialog">
            <div class="modal-header">
                <h3>V√°ltoz√°sok Elemz√©se √©s Elfogad√°sa</h3>
                <div class="header-controls">
                    @if (!string.IsNullOrEmpty(FullLlmResponse))
                    {
                        <button @onclick="ToggleFullResponseView">
                            @(_isFullResponseView ? "Vissza a V√°ltoz√°sokhoz" : "Teljes LLM V√°lasz")
                        </button>
                    }
                    <button class="close-btn" @onclick="Close">&times;</button>
                </div>
            </div>
            <div class="modal-body diff-body">
                <div class="diff-left-pane" style="width: @(_leftPaneWidthPercent.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%;">
                    @if (_isGitDiffMode)
                    {
                        <div class="diff-selector-box">
                            <strong>K√ºl√∂nbs√©gek forr√°sa:</strong>
                            <div class="diff-options">
                                <label><input type="radio" name="diff-mode" @onchange="() => _selectedDiffMode = GitWorkflowService.DiffMode.Uncommitted" checked="@(_selectedDiffMode == GitWorkflowService.DiffMode.Uncommitted)" /> Jelenlegi v√°ltoz√°sok</label>
                                <label><input type="radio" name="diff-mode" @onchange="() => _selectedDiffMode = GitWorkflowService.DiffMode.SinceBranchCreation" checked="@(_selectedDiffMode == GitWorkflowService.DiffMode.SinceBranchCreation)" /> Branch nyit√°sa √≥ta</label>
                                <label><input type="radio" name="diff-mode" @onchange="() => _selectedDiffMode = GitWorkflowService.DiffMode.AgainstBranch" checked="@(_selectedDiffMode == GitWorkflowService.DiffMode.AgainstBranch)" /> M√°sik branch-hez k√©pest</label>
                            </div>
                            @if (_selectedDiffMode == GitWorkflowService.DiffMode.AgainstBranch)
                            {
                                <select @bind="_selectedTargetBranch">
                                    @foreach (var branch in _allBranches)
                                    {
                                        <option value="@branch">@branch</option>
                                    }
                                </select>
                            }
                            <button @onclick="LoadSelectedDiffsAsync" disabled="@_isLoadingDiffs">
                                @if (_isLoadingDiffs)
                                {
                                    <span class="spinner-small"></span>
                                }
                                else
                                {
                                    <span>K√ºl√∂nbs√©gek mutat√°sa</span>
                                }
                            </button>
                        </div>
                    }

                    <div class="suggestion-box">
                        <div class="suggestion-header">
                            <strong>@(_hasSuggestions ? "Javaslatok:" : "Git M≈±veletek")</strong>
                            @if (_isGitDiffMode)
                            {
                                <button class="refresh-btn" @onclick="RefreshSuggestionsAsync" title="Javaslatok friss√≠t√©se" disabled="@_isRefreshingSuggestions">
                                    @if (_isRefreshingSuggestions)
                                    {
                                        <span class="spinner-small"></span>
                                    }
                                    else
                                    {
                                        <span>üîÑ</span>
                                    }
                                </button>
                            }
                        </div>
                        <div class="suggestion-item">
                            <label>Branch:</label>
                            <input type="text" @bind="_suggestedBranch" placeholder="pl. feature/uj-funkcio" />
                            @if (_hasSuggestions)
                            {
                                <button @onclick="() => CopyToClipboard(_suggestedBranch)">M√°sol</button>
                            }
                        </div>
                        <div class="suggestion-item">
                            <label>Commit:</label>
                            <textarea rows="5" @bind="_suggestedCommit" placeholder="pl. feat: √öj funkci√≥ implement√°l√°sa..."></textarea>
                            @if (_hasSuggestions)
                            {
                                <button @onclick="() => CopyToClipboard(_suggestedCommit)">M√°sol</button>
                            }
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(_globalExplanationText))
                    {
                        <div class="diff-global-explanation">
                            <strong>Glob√°lis Magyar√°zat:</strong>
                            <pre>@_globalExplanationText</pre>
                        </div>
                    }
                    <strong>Feldolgozott f√°jlok: (@_localDiffResults.Count)</strong>
                    <fieldset class="file-list-fieldset" disabled="@_isFullResponseView">
                        <div class="diff-file-list">
                            @foreach (var result in _localDiffResults)
                            {
                                <div @key="result.Path"
                                     class="diff-file-item @GetStatusClass(result) @(_selectedResult != null && _selectedResult.Path == result.Path ? "selected" : "")"
                                     @onclick="() => SelectResult(result)">
                                    <input type="checkbox" @bind="result.IsSelectedForAccept" @onclick:stopPropagation />
                                    <span class="status-badge @GetStatusClass(result)">@GetStatusText(result)</span>
                                    <span class="file-path-text" title="@result.Path">@result.Path</span>
                                    
                                    <div class="item-actions">
                                        @if (!string.IsNullOrEmpty(result.Explanation))
                                        {
                                            <span class="comment-indicator" title="Van magyar√°zat">üí¨</span>
                                        }
                                        <button class="reset-btn" @onclick="() => RevertFile(result)" @onclick:stopPropagation title="V√°ltoz√°sok eldob√°sa / vissza√°ll√≠t√°sa">
                                            ‚Ü©Ô∏è
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    </fieldset>
                </div>

                <div class="diff-splitter" @onmousedown="StartPaneResize"></div>

                <div class="diff-right-pane" style="width: @((100 - _leftPaneWidthPercent).ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%;">
                    @if (_isFullResponseView)
                    {
                        <div class="full-response-view">
                            <strong>Teljes LLM v√°lasz:</strong>
                            <textarea readonly>@FullLlmResponse</textarea>
                        </div>
                    }
                    else if (_isGeneratingDiff)
                    {
                        <div class="editor-placeholder">
                            <div class="spinner-small"></div>
                            <span>K√ºl√∂nbs√©gek sz√°m√≠t√°sa...</span>
                        </div>
                    }
                    else if (_selectedResult != null)
                    {
                         @if (!string.IsNullOrEmpty(_selectedResult.Explanation))
                        {
                            <div class="file-explanation-box">
                                <strong>@_selectedResult.Path - Magyar√°zat:</strong>
                                <p>@_selectedResult.Explanation</p>
                            </div>
                        }
                        
                        <div class="diff-view-switcher">
                            <div class="view-modes">
                                <label>
                                    <input type="radio" name="diff-view" value="unified" checked="@(_viewMode == "unified")" @onchange="@(() => SetViewMode("unified"))" />
                                    Egys√©ges n√©zet (Olvas√°s)
                                </label>
                                <label>
                                    <input type="radio" name="diff-view" value="sbs" checked="@(_viewMode == "sbs")" @onchange="@(() => SetViewMode("sbs"))" />
                                    Side-by-Side (Szerkeszt√©s)
                                </label>
                            </div>
                        </div>

                        @if (_viewMode == "sbs")
                        {
                            <div id="sbs-container" class="diff-editor-container" style="gap: 0;">
                                <div class="editor-pane" style="flex: none; width: @(_sbsLeftPaneWidthPercent.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%">
                                    <div class="editor-header">Eredeti (Olvas√°s - Piros: T√∂r√∂lt)</div>
                                    <div id="editor-left-display" class="editor-display-container">
                                        @foreach (var item in _sbsLeftLines)
                                        {
                                            @if (item.IsGap)
                                            {
                                                <div class="sbs-gap" style="height: @(item.HeightInLines * 1.5)em;"></div>
                                            }
                                            else
                                            {
                                                <div class="sbs-line-item @item.CssClass">@item.Content</div>
                                            }
                                        }
                                    </div>
                                    <div class="diff-scrollbar-track">
                                        @foreach (var marker in _sbsLeftMarkers)
                                        {
                                            <div class="diff-marker @marker.Type" style="top: @marker.TopPercent.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)%"></div>
                                        }
                                    </div>
                                </div>

                                <div id="sbs-nav-rail" class="diff-nav-rail" @onclick="OnNavRailClick" title="Kattints a g√∂rget√©shez">
                                    @foreach (var marker in _sbsLeftMarkers)
                                    {
                                        <div class="nav-marker @marker.Type" style="top: @marker.TopPercent.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)%"></div>
                                    }
                                </div>

                                <div class="diff-splitter" @onmousedown="StartSbsResize"></div>

                                <div class="editor-pane" style="flex: none; width: @((100 - _sbsLeftPaneWidthPercent).ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%">
                                    <div class="editor-header">√öj / M√≥dos√≠tott (Szerkeszthet≈ë - Z√∂ld: √öj)</div>
                                    <div class="layered-editor-container">
                                        <div id="editor-backdrop" class="editor-backdrop">
                                            @foreach (var isNew in _editorLineHighlights)
                                            {
                                                <div class="line-bg @(isNew ? "is-new" : "")">&nbsp;</div>
                                            }
                                        </div>
                                        <textarea id="editor-textarea" 
                                                  class="editor-textarea"
                                                  @bind="_selectedResult.NewContent" 
                                                  @bind:event="oninput" 
                                                  @onkeyup="OnContentChanged"
                                                  @onscroll="SyncScroll"></textarea>
                                                  
                                        <div class="diff-scrollbar-track">
                                            @foreach (var marker in _sbsDiffMarkers)
                                            {
                                                <div class="diff-marker @marker.Type" style="top: @marker.TopPercent.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)%"></div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="diff-content-wrapper">
                                <div class="diff-content unified-diff-list">
                                    @foreach (var line in _unifiedDiffLines)
                                    {
                                        <div class="diff-row @GetDiffLineClass(line)" @oncontextmenu="(e) => ShowLineContextMenu(e, line)" @oncontextmenu:preventDefault>
                                            <span class="diff-marker-text">@GetDiffLineMarker(line)</span>
                                            <span class="diff-text">@line.Content</span>
                                        </div>
                                    }
                                </div>
                                <div class="diff-scrollbar-track">
                                    @foreach (var marker in _unifiedDiffMarkers)
                                    {
                                        <div class="diff-marker @marker.Type" style="top: @marker.TopPercent.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)%"></div>
                                    }
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="editor-placeholder">V√°lassz egy f√°jlt a v√°ltoz√°sok megtekint√©s√©hez.</div>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <span>@($"{_localDiffResults.Count(r => r.IsSelectedForAccept)} f√°jl kijel√∂lve")</span>
                <button @onclick="Close">Bez√°r√°s</button>
                <button class="primary" @onclick="AcceptSelectedChanges" disabled="@(!_localDiffResults.Any(r => r.IsSelectedForAccept))">Kijel√∂ltek elfogad√°sa</button>
                <button class="primary" @onclick="CreateBranch" disabled="@(string.IsNullOrWhiteSpace(_suggestedBranch))">Branch L√©trehoz√°sa</button>
                <button class="primary" @onclick="Commit" disabled="@(string.IsNullOrWhiteSpace(_suggestedCommit) || !_localDiffResults.Any(r => r.IsSelectedForAccept))">Commit</button>
                <button class="primary commit-btn" @onclick="Push">Push</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public string GlobalExplanation { get; set; } = string.Empty;
    [Parameter] public string FullLlmResponse { get; set; } = string.Empty;
    [Parameter] public List<DiffResult>? DiffResults { get; set; }
    [Parameter] public EventCallback<List<DiffResult>> OnAccept { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<string> OnCreateBranch { get; set; }
    [Parameter] public EventCallback<CommitAndPushArgs> OnCommit { get; set; }
    [Parameter] public EventCallback<CommitAndPushArgs> OnPush { get; set; }

    private List<DiffResult> _localDiffResults = new();
    private DiffResult? _selectedResult;
    private string _viewMode = "unified";
    private List<DiffUtility.DiffLineItem> _unifiedDiffLines = new();
    private List<DiffMarkerInfo> _unifiedDiffMarkers = new();
    private List<DiffMarkerInfo> _sbsDiffMarkers = new();
    private List<DiffMarkerInfo> _sbsLeftMarkers = new();
    private List<SbsLeftItem> _sbsLeftLines = new();
    private string _suggestedBranch = string.Empty;
    private string _suggestedCommit = string.Empty;
    private string _globalExplanationText = string.Empty;
    private bool _hasSuggestions = false;
    private bool _isFullResponseView = false;
    private bool _isGitDiffMode = false;
    private bool _isGeneratingDiff = false;
    private GitWorkflowService.DiffMode _selectedDiffMode = GitWorkflowService.DiffMode.Uncommitted;
    private List<string> _allBranches = new();
    private string? _selectedTargetBranch;
    private bool _isLoadingDiffs = false;
    private bool _isRefreshingSuggestions = false;
    private bool _prevIsVisible = false;
    private bool _showContextMenu = false;
    private double _contextMenuX, _contextMenuY;
    private DiffUtility.DiffLineItem? _contextMenuTargetLine;
    private double _leftPaneWidthPercent = 35.0;
    private bool _isResizingPane = false;
    private double _windowWidth = 0;
    private double _sbsLeftPaneWidthPercent = 50.0;
    private bool _isResizingSbs = false;
    private double _sbsContainerLeft = 0, _sbsContainerWidth = 0;
    private List<bool> _editorLineHighlights = new();

    private record DiffMarkerInfo(string Type, double TopPercent);
    private record SbsLeftItem(string Content, bool IsGap, int HeightInLines, string CssClass);
    private record BoundingRect(double Left, double Width, double Height);

    protected override void OnInitialized() => AppState.PropertyChanged += OnAppStateChanged;

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !_prevIsVisible)
        {
            _localDiffResults = DiffResults?.ToList() ?? new();
            _isGitDiffMode = string.IsNullOrEmpty(FullLlmResponse);
            if (_isGitDiffMode) await LoadBranchesAsync();
            else ParseGlobalExplanation();
            if (_selectedResult == null) await SelectResult(_localDiffResults.FirstOrDefault());
        }
        _prevIsVisible = IsVisible;
    }

    private async Task SelectResult(DiffResult? result)
    {
        _selectedResult = result;
        if (string.IsNullOrEmpty(_viewMode)) _viewMode = "unified";
        await GenerateDiffViewAsync();
        if (_viewMode == "sbs") UpdateEditorHighlights();
    }

    private async Task GenerateDiffViewAsync()
    {
        _isGeneratingDiff = true;
        StateHasChanged();

        _unifiedDiffLines.Clear();
        _unifiedDiffMarkers.Clear();
        _sbsDiffMarkers.Clear();
        _sbsLeftMarkers.Clear();
        _sbsLeftLines.Clear();

        if (_selectedResult == null) { _isGeneratingDiff = false; return; }

        var oldLines = _selectedResult.OldContent.Replace("\r\n", "\n").Split('\n');
        var newLines = _selectedResult.NewContent.Replace("\r\n", "\n").Split('\n');
        var opcodes = await DiffUtility.GetOpcodesAsync(oldLines, newLines);

        foreach (var op in opcodes)
        {
            switch (op.Tag)
            {
                case 'e':
                    for (int i = 0; i < (op.I2 - op.I1); i++)
                        _unifiedDiffLines.Add(new DiffUtility.DiffLineItem(DiffUtility.DiffLineType.Context, oldLines[op.I1 + i], op.I1 + i, op.J1 + i));
                    break;
                case 'd':
                    for (int i = 0; i < (op.I2 - op.I1); i++)
                        _unifiedDiffLines.Add(new DiffUtility.DiffLineItem(DiffUtility.DiffLineType.Delete, oldLines[op.I1 + i], op.I1 + i, null));
                    break;
                case 'i':
                    for (int j = 0; j < (op.J2 - op.J1); j++)
                        _unifiedDiffLines.Add(new DiffUtility.DiffLineItem(DiffUtility.DiffLineType.Add, newLines[op.J1 + j], null, op.J1 + j));
                    break;
                case 'r':
                    for (int i = 0; i < (op.I2 - op.I1); i++)
                        _unifiedDiffLines.Add(new DiffUtility.DiffLineItem(DiffUtility.DiffLineType.Delete, oldLines[op.I1 + i], op.I1 + i, null));
                    for (int j = 0; j < (op.J2 - op.J1); j++)
                        _unifiedDiffLines.Add(new DiffUtility.DiffLineItem(DiffUtility.DiffLineType.Add, newLines[op.J1 + j], null, op.J1 + j));
                    break;
            }
        }

        GenerateUnifiedMarkers(opcodes);
        GenerateSbsData(opcodes, oldLines, newLines);

        _isGeneratingDiff = false;
        StateHasChanged();
    }

    private void GenerateUnifiedMarkers(List<DiffUtility.DiffOpcode> opcodes)
    {
        double totalLines = _unifiedDiffLines.Count;
        if (totalLines < 1) return;
        double currentLine = 0;
        foreach (var op in opcodes)
        {
            string? markerType = op.Tag switch { 'd' => "del", 'i' => "add", 'r' => "replace", _ => null };
            if (markerType != null) _unifiedDiffMarkers.Add(new DiffMarkerInfo(markerType, (currentLine / totalLines) * 100));
            currentLine += op.Tag switch { 'e' => op.I2 - op.I1, 'd' => op.I2 - op.I1, 'i' => op.J2 - op.J1, 'r' => (op.I2 - op.I1) + (op.J2 - op.J1), _ => 0 };
        }
    }

    private void GenerateSbsData(List<DiffUtility.DiffOpcode> opcodes, string[] oldLines, string[] newLines)
    {
        double totalNewLines = Math.Max(1, newLines.Length);
        foreach (var op in opcodes)
        {
            switch (op.Tag)
            {
                case 'e':
                    for (int i = op.I1; i < op.I2; i++) _sbsLeftLines.Add(new SbsLeftItem(oldLines[i], false, 1, ""));
                    break;
                case 'd':
                    _sbsDiffMarkers.Add(new DiffMarkerInfo("del", (op.J1 / totalNewLines) * 100));
                    for (int i = op.I1; i < op.I2; i++) _sbsLeftLines.Add(new SbsLeftItem(oldLines[i], false, 1, "sbs-del"));
                    break;
                case 'i':
                    _sbsDiffMarkers.Add(new DiffMarkerInfo("add", (op.J1 / totalNewLines) * 100));
                    _sbsLeftLines.Add(new SbsLeftItem("", true, op.J2 - op.J1, ""));
                    break;
                case 'r':
                    _sbsDiffMarkers.Add(new DiffMarkerInfo("replace", (op.J1 / totalNewLines) * 100));
                    for (int i = op.I1; i < op.I2; i++) _sbsLeftLines.Add(new SbsLeftItem(oldLines[i], false, 1, "sbs-del"));
                    if ((op.J2 - op.J1) > (op.I2 - op.I1)) _sbsLeftLines.Add(new SbsLeftItem("", true, (op.J2 - op.J1) - (op.I2 - op.I1), ""));
                    break;
            }
        }
        double totalLeftVisualLines = Math.Max(1, _sbsLeftLines.Sum(x => x.HeightInLines));
        double currentVisualLine = 0;
        foreach (var item in _sbsLeftLines)
        {
            string? mType = item.IsGap ? "add" : (item.CssClass.Contains("sbs-del") ? "del" : null);
            if (mType != null) _sbsLeftMarkers.Add(new DiffMarkerInfo(mType, (currentVisualLine / totalLeftVisualLines) * 100));
            currentVisualLine += item.HeightInLines;
        }
    }

    private void UpdateEditorHighlights()
    {
        _editorLineHighlights.Clear();
        if (_selectedResult == null) return;
        var oldLines = _selectedResult.OldContent.Replace("\r\n", "\n").Split('\n');
        var newLines = _selectedResult.NewContent.Replace("\r\n", "\n").Split('\n');
        var opcodes = DiffUtility.GetOpcodes(oldLines, newLines);
        var flags = new bool[newLines.Length];
        foreach (var op in opcodes) if (op.Tag == 'i' || op.Tag == 'r') for (int j = op.J1; j < op.J2; j++) if (j < flags.Length) flags[j] = true;
        _editorLineHighlights.AddRange(flags);
    }

    private async Task SetViewMode(string newMode) { _viewMode = newMode; if (_viewMode == "sbs") UpdateEditorHighlights(); }
    private async Task OnContentChanged() { await GenerateDiffViewAsync(); UpdateEditorHighlights(); }
    private async Task SyncScroll() => await JSRuntime.InvokeVoidAsync("syncEditorScroll", "editor-textarea", "editor-backdrop", "editor-left-display");
    private async void OnAppStateChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e) { if (e.PropertyName == nameof(AppState.CurrentGitBranch)) await InvokeAsync(StateHasChanged); }
    private void ToggleFullResponseView() => _isFullResponseView = !_isFullResponseView;
    private async Task LoadBranchesAsync() { _allBranches = await GitWorkflowService.GetBranchesAsync(); if (_allBranches.Any()) _selectedTargetBranch = _allBranches.First(); }
    private async Task LoadSelectedDiffsAsync() { _isLoadingDiffs = true; try { _localDiffResults = await GitWorkflowService.GetDiffsAsync(_selectedDiffMode, _selectedTargetBranch); await SelectResult(_localDiffResults.FirstOrDefault()); } finally { _isLoadingDiffs = false; } }
    private async Task RefreshSuggestionsAsync() { _isRefreshingSuggestions = true; try { var (b, c) = await GitSuggestionService.GetSuggestionsAsync(_localDiffResults, _globalExplanationText); _suggestedBranch = b ?? ""; _suggestedCommit = c ?? ""; _hasSuggestions = b != null; } finally { _isRefreshingSuggestions = false; } }
    private void ParseGlobalExplanation() { if (string.IsNullOrEmpty(GlobalExplanation)) return; var bMatch = Regex.Match(GlobalExplanation, @"\[BRANCH_SUGGESTION\]([\s\S]*?)\[/BRANCH_SUGGESTION\]"); var cMatch = Regex.Match(GlobalExplanation, @"\[COMMIT_SUGGESTION\]([\s\S]*?)\[/COMMIT_SUGGESTION\]"); if (bMatch.Success && cMatch.Success) { _suggestedBranch = bMatch.Groups[1].Value.Trim(); _suggestedCommit = cMatch.Groups[1].Value.Trim(); _hasSuggestions = true; } }
    private async Task CopyToClipboard(string t) { if (!string.IsNullOrEmpty(t)) await Clipboard.SetTextAsync(t); }
    private string GetDiffLineClass(DiffUtility.DiffLineItem l) => l.Type == DiffUtility.DiffLineType.Add ? "add" : (l.Type == DiffUtility.DiffLineType.Delete ? "del" : "");
    private string GetDiffLineMarker(DiffUtility.DiffLineItem l) => l.Type == DiffUtility.DiffLineType.Add ? "+" : (l.Type == DiffUtility.DiffLineType.Delete ? "-" : " ");
    private void HideContextMenu() => _showContextMenu = false;
    private void ShowLineContextMenu(MouseEventArgs e, DiffUtility.DiffLineItem l) { if (l.Type == DiffUtility.DiffLineType.Context) return; _contextMenuX = e.ClientX; _contextMenuY = e.ClientY; _contextMenuTargetLine = l; _showContextMenu = true; }
    private async Task AcceptSelectedChanges() { var acc = _localDiffResults.Where(r => r.IsSelectedForAccept).ToList(); if (acc.Any()) await OnAccept.InvokeAsync(acc); }
    private async Task CreateBranch() { if (!string.IsNullOrEmpty(_suggestedBranch)) await OnCreateBranch.InvokeAsync(_suggestedBranch); }
    private async Task Commit() { var acc = _localDiffResults.Where(r => r.IsSelectedForAccept).ToList(); if (acc.Any()) await OnCommit.InvokeAsync(new CommitAndPushArgs(_suggestedBranch, _suggestedCommit, acc)); }
    private async Task Push() => await OnPush.InvokeAsync(new CommitAndPushArgs(AppState.CurrentGitBranch, _suggestedCommit, _localDiffResults.Where(r => r.IsSelectedForAccept).ToList()));
    private string GetStatusText(DiffResult r) => r.Status.ToString().ToUpper();
    private string GetStatusClass(DiffResult r) => r.Status.ToString().ToLower();
    private async Task Close() { await OnClose.InvokeAsync(); }
    private async Task RevertFile(DiffResult r) { if (_isGitDiffMode) await GitWorkflowService.DiscardFileChangesAsync(r); else _localDiffResults.Remove(r); await LoadSelectedDiffsAsync(); }
    private async Task StartPaneResize(MouseEventArgs e) { _isResizingPane = true; _windowWidth = await JSRuntime.InvokeAsync<double>("eval", "window.innerWidth"); }
    private void StopPaneResize(MouseEventArgs e) { _isResizingPane = false; _isResizingSbs = false; }
    private void OnMouseMove(MouseEventArgs e) { if (_isResizingPane) _leftPaneWidthPercent = Math.Clamp((e.ClientX / _windowWidth) * 100, 15, 85); }
    private async Task StartSbsResize(MouseEventArgs e) { _isResizingSbs = true; var r = await JSRuntime.InvokeAsync<BoundingRect>("getElementBoundingClientRect", "sbs-container"); if (r != null) { _sbsContainerLeft = r.Left; _sbsContainerWidth = r.Width; } }
    private async Task OnNavRailClick(MouseEventArgs e) { var r = await JSRuntime.InvokeAsync<BoundingRect>("getElementBoundingClientRect", "sbs-nav-rail"); if (r != null) await JSRuntime.InvokeVoidAsync("scrollEditorToPercent", "editor-textarea", e.OffsetY / r.Height); }
    public void Dispose() => AppState.PropertyChanged -= OnAppStateChanged;
}