@inject AppState AppState

@if (IsVisible)
{
    <div class="modal-backdrop">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3>Azure DevOps Work Items Letöltése</h3>
                <button class="close-btn" @onclick="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="ado-dialog-body">
                    <p>
                        Add meg a csatlakozási adatokat a work item-ek (User Story, Bug, stb.) letöltéséhez.
                        A letöltött elemek a projekt mappán belül egy `.ado_workitems` könyvtárba kerülnek.
                    </p>
                    <div class="ado-form-group">
                        <label for="ado-org">Szervezet URL:</label>
                        <input id="ado-org" type="text" placeholder="https://dev.azure.com/your-organization" @bind="AppState.AzureDevOpsOrganizationUrl" />
                    </div>
                    <div class="ado-form-group">
                        <label for="ado-project">Projekt Név:</label>
                        <input id="ado-project" type="text" placeholder="YourProject" @bind="AppState.AzureDevOpsProject" />
                    </div>
                    <div class="ado-form-group">
                        <label for="ado-iteration">Iteration Path (opcionális):</label>
                        <input id="ado-iteration" type="text" placeholder="pl. DmsSolutions\ePostaláda\2025\13" @bind="AppState.AzureDevOpsIterationPath" />
                    </div>
                    <div class="ado-form-group">
                        <label for="ado-pat">Personal Access Token (PAT):</label>
                        <input id="ado-pat" type="password" @bind="AppState.AzureDevOpsPat" />
                    </div>

                    @if (AppState.AdoLastDownloadDate.HasValue)
                    {
                        <div class="ado-incremental-info">
                            <p><strong>Utolsó letöltés:</strong> @AppState.AdoLastDownloadDate.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</p>
                            <p>Letöltheted csak az ezutáni változásokat, vagy elvégezhetsz egy teljes újraszinkronizálást, ami minden helyi ADO adatot töröl és újra letölti az összeset.</p>
                        </div>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button @onclick="Close">Mégsem</button>
                @if (AppState.AdoLastDownloadDate.HasValue)
                {
                    <button @onclick="() => StartDownload(false)" disabled="@IsDownloadDisabled()">Teljes Újratöltés</button>
                    <button class="primary" @onclick="() => StartDownload(true)" disabled="@IsDownloadDisabled()">Csak az újak letöltése</button>
                }
                else
                {
                    <button class="primary" @onclick="() => StartDownload(false)" disabled="@IsDownloadDisabled()">Letöltés</button>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback<bool> OnDownload { get; set; }

    private bool IsDownloadDisabled() =>
        string.IsNullOrWhiteSpace(AppState.AzureDevOpsOrganizationUrl) ||
        string.IsNullOrWhiteSpace(AppState.AzureDevOpsProject) ||
        string.IsNullOrWhiteSpace(AppState.AzureDevOpsPat);

    private async Task StartDownload(bool isIncremental)
    {
        await OnDownload.InvokeAsync(isIncremental);
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }
}